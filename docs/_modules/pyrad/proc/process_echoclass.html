
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>pyrad.proc.process_echoclass &#8212; pyrad 0.1.0 documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for pyrad.proc.process_echoclass</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">pyrad.proc.process_echoclass</span>
<span class="sd">===============================</span>

<span class="sd">Functions for echo classification and filtering</span>

<span class="sd">.. autosummary::</span>
<span class="sd">    :toctree: generated/</span>

<span class="sd">    process_echo_id</span>
<span class="sd">    process_birds_id</span>
<span class="sd">    process_clt_to_echo_id</span>
<span class="sd">    process_echo_filter</span>
<span class="sd">    process_cdf</span>
<span class="sd">    process_filter_snr</span>
<span class="sd">    process_filter_vel_diff</span>
<span class="sd">    process_filter_visibility</span>
<span class="sd">    process_outlier_filter</span>
<span class="sd">    process_hydroclass</span>
<span class="sd">    process_melting_layer</span>
<span class="sd">    process_zdr_column</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">copy</span> <span class="k">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">warnings</span> <span class="k">import</span> <span class="n">warn</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">pyart</span>

<span class="kn">from</span> <span class="nn">..io.io_aux</span> <span class="k">import</span> <span class="n">get_datatype_fields</span><span class="p">,</span> <span class="n">get_fieldname_pyart</span>


<div class="viewcode-block" id="process_echo_id"><a class="viewcode-back" href="../../../proc.html#pyrad.proc.process_echo_id">[docs]</a><span class="k">def</span> <span class="nf">process_echo_id</span><span class="p">(</span><span class="n">procstatus</span><span class="p">,</span> <span class="n">dscfg</span><span class="p">,</span> <span class="n">radar_list</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    identifies echoes as 0: No data, 1: Noise, 2: Clutter,</span>
<span class="sd">    3: Precipitation</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    procstatus : int</span>
<span class="sd">        Processing status: 0 initializing, 1 processing volume,</span>
<span class="sd">        2 post-processing</span>
<span class="sd">    dscfg : dictionary of dictionaries</span>
<span class="sd">        data set configuration. Accepted Configuration Keywords::</span>

<span class="sd">        datatype : list of string. Dataset keyword</span>
<span class="sd">            The input data types</span>
<span class="sd">    radar_list : list of Radar objects</span>
<span class="sd">        Optional. list of radar objects</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    new_dataset : dict</span>
<span class="sd">        dictionary containing the output</span>
<span class="sd">    ind_rad : int</span>
<span class="sd">        radar index</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">procstatus</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">datatypedescr</span> <span class="ow">in</span> <span class="n">dscfg</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]:</span>
        <span class="n">radarnr</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">datatype</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_datatype_fields</span><span class="p">(</span><span class="n">datatypedescr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;dBZ&#39;</span><span class="p">:</span>
            <span class="n">refl_field</span> <span class="o">=</span> <span class="s1">&#39;reflectivity&#39;</span>
        <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;dBuZ&#39;</span><span class="p">:</span>
            <span class="n">refl_field</span> <span class="o">=</span> <span class="s1">&#39;unfiltered_reflectivity&#39;</span>
        <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;ZDR&#39;</span><span class="p">:</span>
            <span class="n">zdr_field</span> <span class="o">=</span> <span class="s1">&#39;differential_reflectivity&#39;</span>
        <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;ZDRu&#39;</span><span class="p">:</span>
            <span class="n">zdr_field</span> <span class="o">=</span> <span class="s1">&#39;unfiltered_differential_reflectivity&#39;</span>
        <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;RhoHV&#39;</span><span class="p">:</span>
            <span class="n">rhv_field</span> <span class="o">=</span> <span class="s1">&#39;cross_correlation_ratio&#39;</span>
        <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;uPhiDP&#39;</span><span class="p">:</span>
            <span class="n">phi_field</span> <span class="o">=</span> <span class="s1">&#39;uncorrected_differential_phase&#39;</span>

    <span class="n">ind_rad</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">radarnr</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">8</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span>
    <span class="k">if</span> <span class="n">radar_list</span><span class="p">[</span><span class="n">ind_rad</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;No valid radar&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">radar</span> <span class="o">=</span> <span class="n">radar_list</span><span class="p">[</span><span class="n">ind_rad</span><span class="p">]</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">refl_field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">radar</span><span class="o">.</span><span class="n">fields</span><span class="p">)</span> <span class="ow">or</span>
            <span class="p">(</span><span class="n">zdr_field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">radar</span><span class="o">.</span><span class="n">fields</span><span class="p">)</span> <span class="ow">or</span>
            <span class="p">(</span><span class="n">rhv_field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">radar</span><span class="o">.</span><span class="n">fields</span><span class="p">)</span> <span class="ow">or</span>
            <span class="p">(</span><span class="n">phi_field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">radar</span><span class="o">.</span><span class="n">fields</span><span class="p">)):</span>
        <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Unable to create radar_echo_id dataset. Missing data&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="n">echo_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">radar</span><span class="o">.</span><span class="n">nrays</span><span class="p">,</span> <span class="n">radar</span><span class="o">.</span><span class="n">ngates</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span><span class="o">+</span><span class="mi">3</span>

    <span class="c1"># look for clutter</span>
    <span class="n">gatefilter</span> <span class="o">=</span> <span class="n">pyart</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">moment_and_texture_based_gate_filter</span><span class="p">(</span>
        <span class="n">radar</span><span class="p">,</span> <span class="n">zdr_field</span><span class="o">=</span><span class="n">zdr_field</span><span class="p">,</span> <span class="n">rhv_field</span><span class="o">=</span><span class="n">rhv_field</span><span class="p">,</span> <span class="n">phi_field</span><span class="o">=</span><span class="n">phi_field</span><span class="p">,</span>
        <span class="n">refl_field</span><span class="o">=</span><span class="n">refl_field</span><span class="p">,</span> <span class="n">textzdr_field</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">textrhv_field</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">textphi_field</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">textrefl_field</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wind_size</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
        <span class="n">max_textphi</span><span class="o">=</span><span class="mf">20.</span><span class="p">,</span> <span class="n">max_textrhv</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">max_textzdr</span><span class="o">=</span><span class="mf">2.85</span><span class="p">,</span>
        <span class="n">max_textrefl</span><span class="o">=</span><span class="mf">8.</span><span class="p">,</span> <span class="n">min_rhv</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>

    <span class="n">is_clutter</span> <span class="o">=</span> <span class="n">gatefilter</span><span class="o">.</span><span class="n">gate_excluded</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="n">echo_id</span><span class="p">[</span><span class="n">is_clutter</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="c1"># look for noise</span>
    <span class="n">is_noise</span> <span class="o">=</span> <span class="n">radar</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">refl_field</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="p">(</span>
        <span class="n">pyart</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_fillvalue</span><span class="p">())</span>
    <span class="n">echo_id</span><span class="p">[</span><span class="n">is_noise</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">id_field</span> <span class="o">=</span> <span class="n">pyart</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s1">&#39;radar_echo_id&#39;</span><span class="p">)</span>
    <span class="n">id_field</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">echo_id</span>
    <span class="n">id_field</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;_FillValue&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>

    <span class="c1"># prepare for exit</span>
    <span class="n">new_dataset</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;radar_out&#39;</span><span class="p">:</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">radar</span><span class="p">)}</span>
    <span class="n">new_dataset</span><span class="p">[</span><span class="s1">&#39;radar_out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">new_dataset</span><span class="p">[</span><span class="s1">&#39;radar_out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="s1">&#39;radar_echo_id&#39;</span><span class="p">,</span> <span class="n">id_field</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">new_dataset</span><span class="p">,</span> <span class="n">ind_rad</span></div>


<div class="viewcode-block" id="process_birds_id"><a class="viewcode-back" href="../../../proc.html#pyrad.proc.process_birds_id">[docs]</a><span class="k">def</span> <span class="nf">process_birds_id</span><span class="p">(</span><span class="n">procstatus</span><span class="p">,</span> <span class="n">dscfg</span><span class="p">,</span> <span class="n">radar_list</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    identifies echoes as 0: No data, 1: Noise, 2: Clutter,</span>
<span class="sd">    3: Birds</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    procstatus : int</span>
<span class="sd">        Processing status: 0 initializing, 1 processing volume,</span>
<span class="sd">        2 post-processing</span>
<span class="sd">    dscfg : dictionary of dictionaries</span>
<span class="sd">        data set configuration. Accepted Configuration Keywords::</span>

<span class="sd">        datatype : list of string. Dataset keyword</span>
<span class="sd">            The input data types</span>
<span class="sd">    radar_list : list of Radar objects</span>
<span class="sd">        Optional. list of radar objects</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    new_dataset : dict</span>
<span class="sd">        dictionary containing the output</span>
<span class="sd">    ind_rad : int</span>
<span class="sd">        radar index</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">procstatus</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">datatypedescr</span> <span class="ow">in</span> <span class="n">dscfg</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]:</span>
        <span class="n">radarnr</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">datatype</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_datatype_fields</span><span class="p">(</span><span class="n">datatypedescr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;dBZ&#39;</span><span class="p">:</span>
            <span class="n">refl_field</span> <span class="o">=</span> <span class="s1">&#39;reflectivity&#39;</span>
        <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;dBuZ&#39;</span><span class="p">:</span>
            <span class="n">refl_field</span> <span class="o">=</span> <span class="s1">&#39;unfiltered_reflectivity&#39;</span>
        <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;ZDR&#39;</span><span class="p">:</span>
            <span class="n">zdr_field</span> <span class="o">=</span> <span class="s1">&#39;differential_reflectivity&#39;</span>
        <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;ZDRu&#39;</span><span class="p">:</span>
            <span class="n">zdr_field</span> <span class="o">=</span> <span class="s1">&#39;unfiltered_differential_reflectivity&#39;</span>
        <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;RhoHV&#39;</span><span class="p">:</span>
            <span class="n">rhv_field</span> <span class="o">=</span> <span class="s1">&#39;cross_correlation_ratio&#39;</span>

    <span class="n">ind_rad</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">radarnr</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">8</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span>
    <span class="k">if</span> <span class="n">radar_list</span><span class="p">[</span><span class="n">ind_rad</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;No valid radar&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">radar</span> <span class="o">=</span> <span class="n">radar_list</span><span class="p">[</span><span class="n">ind_rad</span><span class="p">]</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">refl_field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">radar</span><span class="o">.</span><span class="n">fields</span><span class="p">)</span> <span class="ow">or</span>
            <span class="p">(</span><span class="n">zdr_field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">radar</span><span class="o">.</span><span class="n">fields</span><span class="p">)</span> <span class="ow">or</span>
            <span class="p">(</span><span class="n">rhv_field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">radar</span><span class="o">.</span><span class="n">fields</span><span class="p">)):</span>
        <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Unable to create radar_echo_id dataset. Missing data&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="c1"># user defined parameters</span>
    <span class="n">max_zdr</span> <span class="o">=</span> <span class="n">dscfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_zdr&#39;</span><span class="p">,</span> <span class="mf">3.</span><span class="p">)</span>
    <span class="n">max_rhv</span> <span class="o">=</span> <span class="n">dscfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_rhv&#39;</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">)</span>
    <span class="n">max_refl</span> <span class="o">=</span> <span class="n">dscfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_refl&#39;</span><span class="p">,</span> <span class="mf">20.</span><span class="p">)</span>
    <span class="n">rmin</span> <span class="o">=</span> <span class="n">dscfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rmin&#39;</span><span class="p">,</span> <span class="mf">2000.</span><span class="p">)</span>
    <span class="n">rmax</span> <span class="o">=</span> <span class="n">dscfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rmax&#39;</span><span class="p">,</span> <span class="mf">25000.</span><span class="p">)</span>
    <span class="n">elmin</span> <span class="o">=</span> <span class="n">dscfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;elmin&#39;</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">)</span>
    <span class="n">elmax</span> <span class="o">=</span> <span class="n">dscfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;elmax&#39;</span><span class="p">,</span> <span class="mf">85.</span><span class="p">)</span>
    <span class="n">echo_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">radar</span><span class="o">.</span><span class="n">nrays</span><span class="p">,</span> <span class="n">radar</span><span class="o">.</span><span class="n">ngates</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span><span class="o">+</span><span class="mi">3</span>

    <span class="c1"># look for clutter</span>
    <span class="n">gatefilter</span> <span class="o">=</span> <span class="n">pyart</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">birds_gate_filter</span><span class="p">(</span>
        <span class="n">radar</span><span class="p">,</span> <span class="n">zdr_field</span><span class="o">=</span><span class="n">zdr_field</span><span class="p">,</span> <span class="n">rhv_field</span><span class="o">=</span><span class="n">rhv_field</span><span class="p">,</span>
        <span class="n">refl_field</span><span class="o">=</span><span class="n">refl_field</span><span class="p">,</span> <span class="n">max_zdr</span><span class="o">=</span><span class="n">max_zdr</span><span class="p">,</span> <span class="n">max_rhv</span><span class="o">=</span><span class="n">max_rhv</span><span class="p">,</span>
        <span class="n">max_refl</span><span class="o">=</span><span class="n">max_refl</span><span class="p">,</span> <span class="n">rmin</span><span class="o">=</span><span class="n">rmin</span><span class="p">,</span> <span class="n">rmax</span><span class="o">=</span><span class="n">rmax</span><span class="p">,</span> <span class="n">elmin</span><span class="o">=</span><span class="n">elmin</span><span class="p">,</span> <span class="n">elmax</span><span class="o">=</span><span class="n">elmax</span><span class="p">)</span>

    <span class="n">is_clutter</span> <span class="o">=</span> <span class="n">gatefilter</span><span class="o">.</span><span class="n">gate_excluded</span> <span class="o">==</span> <span class="mi">1</span>
    <span class="n">echo_id</span><span class="p">[</span><span class="n">is_clutter</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="c1"># look for noise</span>
    <span class="n">is_noise</span> <span class="o">=</span> <span class="n">radar</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">refl_field</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">==</span> <span class="p">(</span>
        <span class="n">pyart</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_fillvalue</span><span class="p">())</span>
    <span class="n">echo_id</span><span class="p">[</span><span class="n">is_noise</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">id_field</span> <span class="o">=</span> <span class="n">pyart</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s1">&#39;radar_echo_id&#39;</span><span class="p">)</span>
    <span class="n">id_field</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">echo_id</span>

    <span class="c1"># prepare for exit</span>
    <span class="n">new_dataset</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;radar_out&#39;</span><span class="p">:</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">radar</span><span class="p">)}</span>
    <span class="n">new_dataset</span><span class="p">[</span><span class="s1">&#39;radar_out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">new_dataset</span><span class="p">[</span><span class="s1">&#39;radar_out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="s1">&#39;radar_echo_id&#39;</span><span class="p">,</span> <span class="n">id_field</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">new_dataset</span><span class="p">,</span> <span class="n">ind_rad</span></div>


<div class="viewcode-block" id="process_clt_to_echo_id"><a class="viewcode-back" href="../../../proc.html#pyrad.proc.process_clt_to_echo_id">[docs]</a><span class="k">def</span> <span class="nf">process_clt_to_echo_id</span><span class="p">(</span><span class="n">procstatus</span><span class="p">,</span> <span class="n">dscfg</span><span class="p">,</span> <span class="n">radar_list</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts clutter exit code from rad4alp into pyrad echo ID</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    procstatus : int</span>
<span class="sd">        Processing status: 0 initializing, 1 processing volume,</span>
<span class="sd">        2 post-processing</span>
<span class="sd">    dscfg : dictionary of dictionaries</span>
<span class="sd">        data set configuration. Accepted Configuration Keywords::</span>

<span class="sd">        datatype : list of string. Dataset keyword</span>
<span class="sd">            The input data types</span>
<span class="sd">    radar_list : list of Radar objects</span>
<span class="sd">        Optional. list of radar objects</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    new_dataset : dict</span>
<span class="sd">        dictionary containing the output</span>
<span class="sd">    ind_rad : int</span>
<span class="sd">        radar index</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">procstatus</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">datatypedescr</span> <span class="ow">in</span> <span class="n">dscfg</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]:</span>
        <span class="n">radarnr</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">datatype</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_datatype_fields</span><span class="p">(</span><span class="n">datatypedescr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;CLT&#39;</span><span class="p">:</span>
            <span class="n">clt_field</span> <span class="o">=</span> <span class="s1">&#39;clutter_exit_code&#39;</span>
            <span class="k">break</span>

    <span class="n">ind_rad</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">radarnr</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">8</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span>
    <span class="k">if</span> <span class="n">radar_list</span><span class="p">[</span><span class="n">ind_rad</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;No valid radar&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">radar</span> <span class="o">=</span> <span class="n">radar_list</span><span class="p">[</span><span class="n">ind_rad</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">clt_field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">radar</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
        <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;rad4alp clutter exit code not present. Unable to obtain echoID&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="n">echo_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">radar</span><span class="o">.</span><span class="n">nrays</span><span class="p">,</span> <span class="n">radar</span><span class="o">.</span><span class="n">ngates</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span><span class="o">+</span><span class="mi">3</span>
    <span class="n">clt</span> <span class="o">=</span> <span class="n">radar</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">clt_field</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
    <span class="n">echo_id</span><span class="p">[</span><span class="n">clt</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">echo_id</span><span class="p">[</span><span class="n">clt</span> <span class="o">&gt;=</span> <span class="mi">100</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>

    <span class="n">id_field</span> <span class="o">=</span> <span class="n">pyart</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span><span class="s1">&#39;radar_echo_id&#39;</span><span class="p">)</span>
    <span class="n">id_field</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">echo_id</span>

    <span class="c1"># prepare for exit</span>
    <span class="n">new_dataset</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;radar_out&#39;</span><span class="p">:</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">radar</span><span class="p">)}</span>
    <span class="n">new_dataset</span><span class="p">[</span><span class="s1">&#39;radar_out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">new_dataset</span><span class="p">[</span><span class="s1">&#39;radar_out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="s1">&#39;radar_echo_id&#39;</span><span class="p">,</span> <span class="n">id_field</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">new_dataset</span><span class="p">,</span> <span class="n">ind_rad</span></div>


<div class="viewcode-block" id="process_echo_filter"><a class="viewcode-back" href="../../../proc.html#pyrad.proc.process_echo_filter">[docs]</a><span class="k">def</span> <span class="nf">process_echo_filter</span><span class="p">(</span><span class="n">procstatus</span><span class="p">,</span> <span class="n">dscfg</span><span class="p">,</span> <span class="n">radar_list</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Masks all echo types that are not of the class specified in</span>
<span class="sd">    keyword echo_type</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    procstatus : int</span>
<span class="sd">        Processing status: 0 initializing, 1 processing volume,</span>
<span class="sd">        2 post-processing</span>
<span class="sd">    dscfg : dictionary of dictionaries</span>
<span class="sd">        data set configuration. Accepted Configuration Keywords::</span>

<span class="sd">        datatype : list of string. Dataset keyword</span>
<span class="sd">            The input data types</span>
<span class="sd">        echo_type : int</span>
<span class="sd">            The type of echo to keep: 1 noise, 2 clutter, 3 precipitation.</span>
<span class="sd">            Default 3</span>
<span class="sd">    radar_list : list of Radar objects</span>
<span class="sd">        Optional. list of radar objects</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    new_dataset : dict</span>
<span class="sd">        dictionary containing the output</span>
<span class="sd">    ind_rad : int</span>
<span class="sd">        radar index</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">procstatus</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">datatypedescr</span> <span class="ow">in</span> <span class="n">dscfg</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]:</span>
        <span class="n">radarnr</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">datatype</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_datatype_fields</span><span class="p">(</span><span class="n">datatypedescr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;echoID&#39;</span><span class="p">:</span>
            <span class="n">echoid_field</span> <span class="o">=</span> <span class="n">get_fieldname_pyart</span><span class="p">(</span><span class="n">datatype</span><span class="p">)</span>
            <span class="k">break</span>

    <span class="n">ind_rad</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">radarnr</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">8</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span>
    <span class="k">if</span> <span class="n">radar_list</span><span class="p">[</span><span class="n">ind_rad</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;No valid radar&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">radar</span> <span class="o">=</span> <span class="n">radar_list</span><span class="p">[</span><span class="n">ind_rad</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">echoid_field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">radar</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
        <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Unable to filter data. Missing echo ID field&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="n">echo_type</span> <span class="o">=</span> <span class="n">dscfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;echo_type&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">radar</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">echoid_field</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">echo_type</span>

    <span class="n">new_dataset</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;radar_out&#39;</span><span class="p">:</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">radar</span><span class="p">)}</span>
    <span class="n">new_dataset</span><span class="p">[</span><span class="s1">&#39;radar_out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">datatypedescr</span> <span class="ow">in</span> <span class="n">dscfg</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]:</span>
        <span class="n">radarnr</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">datatype</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_datatype_fields</span><span class="p">(</span><span class="n">datatypedescr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;echoID&#39;</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">field_name</span> <span class="o">=</span> <span class="n">get_fieldname_pyart</span><span class="p">(</span><span class="n">datatype</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">field_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">radar</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Unable to filter &#39;</span><span class="o">+</span><span class="n">field_name</span><span class="o">+</span><span class="s1">&#39; according to echo ID. &#39;</span> <span class="o">+</span>
                 <span class="s1">&#39;No valid input fields&#39;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">radar_field</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">radar</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">])</span>
        <span class="n">radar_field</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span>
            <span class="n">mask</span><span class="p">,</span> <span class="n">radar_field</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">field_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;corrected_&#39;</span><span class="p">):</span>
            <span class="n">new_field_name</span> <span class="o">=</span> <span class="n">field_name</span>
        <span class="k">elif</span> <span class="n">field_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;uncorrected_&#39;</span><span class="p">):</span>
            <span class="n">new_field_name</span> <span class="o">=</span> <span class="n">field_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                <span class="s1">&#39;uncorrected_&#39;</span><span class="p">,</span> <span class="s1">&#39;corrected_&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_field_name</span> <span class="o">=</span> <span class="s1">&#39;corrected_&#39;</span><span class="o">+</span><span class="n">field_name</span>
        <span class="n">new_dataset</span><span class="p">[</span><span class="s1">&#39;radar_out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="n">new_field_name</span><span class="p">,</span> <span class="n">radar_field</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">new_dataset</span><span class="p">[</span><span class="s1">&#39;radar_out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">new_dataset</span><span class="p">,</span> <span class="n">ind_rad</span></div>


<div class="viewcode-block" id="process_cdf"><a class="viewcode-back" href="../../../proc.html#pyrad.proc.process_cdf">[docs]</a><span class="k">def</span> <span class="nf">process_cdf</span><span class="p">(</span><span class="n">procstatus</span><span class="p">,</span> <span class="n">dscfg</span><span class="p">,</span> <span class="n">radar_list</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Collects the fields necessary to compute the Cumulative Distribution</span>
<span class="sd">    Function</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    procstatus : int</span>
<span class="sd">        Processing status: 0 initializing, 1 processing volume,</span>
<span class="sd">        2 post-processing</span>
<span class="sd">    dscfg : dictionary of dictionaries</span>
<span class="sd">        data set configuration. Accepted Configuration Keywords::</span>

<span class="sd">        datatype : list of string. Dataset keyword</span>
<span class="sd">            The input data types</span>
<span class="sd">    radar_list : list of Radar objects</span>
<span class="sd">        Optional. list of radar objects</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    new_dataset : dict</span>
<span class="sd">        dictionary containing the output</span>
<span class="sd">    ind_rad : int</span>
<span class="sd">        radar index</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">procstatus</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="n">echoid_field</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">hydro_field</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">vis_field</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">datatypedescr</span> <span class="ow">in</span> <span class="n">dscfg</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]:</span>
        <span class="n">radarnr</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">datatype</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_datatype_fields</span><span class="p">(</span><span class="n">datatypedescr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;echoID&#39;</span><span class="p">:</span>
            <span class="n">echoid_field</span> <span class="o">=</span> <span class="n">get_fieldname_pyart</span><span class="p">(</span><span class="n">datatype</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;hydro&#39;</span><span class="p">:</span>
            <span class="n">hydro_field</span> <span class="o">=</span> <span class="n">get_fieldname_pyart</span><span class="p">(</span><span class="n">datatype</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;VIS&#39;</span><span class="p">:</span>
            <span class="n">vis_field</span> <span class="o">=</span> <span class="n">get_fieldname_pyart</span><span class="p">(</span><span class="n">datatype</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">field_name</span> <span class="o">=</span> <span class="n">get_fieldname_pyart</span><span class="p">(</span><span class="n">datatype</span><span class="p">)</span>

    <span class="n">ind_rad</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">radarnr</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">8</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span>
    <span class="k">if</span> <span class="n">radar_list</span><span class="p">[</span><span class="n">ind_rad</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;No valid radar&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">radar</span> <span class="o">=</span> <span class="n">radar_list</span><span class="p">[</span><span class="n">ind_rad</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">field_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">radar</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
        <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Unable to compute CDF. Missing field&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="n">new_dataset</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;radar_out&#39;</span><span class="p">:</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">radar</span><span class="p">)}</span>
    <span class="n">new_dataset</span><span class="p">[</span><span class="s1">&#39;radar_out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="n">new_dataset</span><span class="p">[</span><span class="s1">&#39;radar_out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">radar</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">echoid_field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">echoid_field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">radar</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Missing echo ID field. Clutter can not be filtered&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_dataset</span><span class="p">[</span><span class="s1">&#39;radar_out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span>
                <span class="n">echoid_field</span><span class="p">,</span> <span class="n">radar</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">echoid_field</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">hydro_field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">hydro_field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">radar</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Missing hydrometeor type field. &#39;</span> <span class="o">+</span>
                 <span class="s1">&#39;Filtration according to hydrometeor type not possible&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_dataset</span><span class="p">[</span><span class="s1">&#39;radar_out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span>
                <span class="n">hydro_field</span><span class="p">,</span> <span class="n">radar</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">hydro_field</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">vis_field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">vis_field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">radar</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Missing visibility field. Blocked gates can not be filtered&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_dataset</span><span class="p">[</span><span class="s1">&#39;radar_out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span>
                <span class="n">vis_field</span><span class="p">,</span> <span class="n">radar</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">vis_field</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">new_dataset</span><span class="p">,</span> <span class="n">ind_rad</span></div>


<div class="viewcode-block" id="process_filter_snr"><a class="viewcode-back" href="../../../proc.html#pyrad.proc.process_filter_snr">[docs]</a><span class="k">def</span> <span class="nf">process_filter_snr</span><span class="p">(</span><span class="n">procstatus</span><span class="p">,</span> <span class="n">dscfg</span><span class="p">,</span> <span class="n">radar_list</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    filters out low SNR echoes</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    procstatus : int</span>
<span class="sd">        Processing status: 0 initializing, 1 processing volume,</span>
<span class="sd">        2 post-processing</span>
<span class="sd">    dscfg : dictionary of dictionaries</span>
<span class="sd">        data set configuration. Accepted Configuration Keywords::</span>

<span class="sd">        datatype : list of string. Dataset keyword</span>
<span class="sd">            The input data types</span>
<span class="sd">        SNRmin : float. Dataset keyword</span>
<span class="sd">            The minimum SNR to keep the data.</span>
<span class="sd">    radar_list : list of Radar objects</span>
<span class="sd">        Optional. list of radar objects</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    new_dataset : dict</span>
<span class="sd">        dictionary containing the output</span>
<span class="sd">    ind_rad : int</span>
<span class="sd">        radar index</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">procstatus</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">datatypedescr</span> <span class="ow">in</span> <span class="n">dscfg</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]:</span>
        <span class="n">radarnr</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">datatype</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_datatype_fields</span><span class="p">(</span><span class="n">datatypedescr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">datatype</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;SNRh&#39;</span><span class="p">,</span> <span class="s1">&#39;SNRv&#39;</span><span class="p">):</span>
            <span class="n">snr_field</span> <span class="o">=</span> <span class="n">get_fieldname_pyart</span><span class="p">(</span><span class="n">datatype</span><span class="p">)</span>
            <span class="k">break</span>

    <span class="n">ind_rad</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">radarnr</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">8</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span>
    <span class="k">if</span> <span class="n">radar_list</span><span class="p">[</span><span class="n">ind_rad</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;No valid radar&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">radar</span> <span class="o">=</span> <span class="n">radar_list</span><span class="p">[</span><span class="n">ind_rad</span><span class="p">]</span>

    <span class="n">new_dataset</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;radar_out&#39;</span><span class="p">:</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">radar</span><span class="p">)}</span>
    <span class="n">new_dataset</span><span class="p">[</span><span class="s1">&#39;radar_out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">snr_field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">radar</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
        <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Unable to filter dataset according to SNR. Missing SNR field&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="n">gatefilter</span> <span class="o">=</span> <span class="n">pyart</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">snr_based_gate_filter</span><span class="p">(</span>
        <span class="n">radar</span><span class="p">,</span> <span class="n">snr_field</span><span class="o">=</span><span class="n">snr_field</span><span class="p">,</span> <span class="n">min_snr</span><span class="o">=</span><span class="n">dscfg</span><span class="p">[</span><span class="s1">&#39;SNRmin&#39;</span><span class="p">])</span>
    <span class="n">is_low_snr</span> <span class="o">=</span> <span class="n">gatefilter</span><span class="o">.</span><span class="n">gate_excluded</span> <span class="o">==</span> <span class="mi">1</span>

    <span class="k">for</span> <span class="n">datatypedescr</span> <span class="ow">in</span> <span class="n">dscfg</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]:</span>
        <span class="n">radarnr</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">datatype</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_datatype_fields</span><span class="p">(</span><span class="n">datatypedescr</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">datatype</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;SNRh&#39;</span><span class="p">,</span> <span class="s1">&#39;SNRv&#39;</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="n">field_name</span> <span class="o">=</span> <span class="n">get_fieldname_pyart</span><span class="p">(</span><span class="n">datatype</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">field_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">radar</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Unable to filter &#39;</span><span class="o">+</span><span class="n">field_name</span> <span class="o">+</span>
                 <span class="s1">&#39; according to SNR. &#39;</span><span class="o">+</span><span class="s1">&#39;No valid input fields&#39;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">radar_field</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">radar</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">])</span>
        <span class="n">radar_field</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span>
            <span class="n">is_low_snr</span><span class="p">,</span> <span class="n">radar_field</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">field_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;corrected_&#39;</span><span class="p">):</span>
            <span class="n">new_field_name</span> <span class="o">=</span> <span class="n">field_name</span>
        <span class="k">elif</span> <span class="n">field_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;uncorrected_&#39;</span><span class="p">):</span>
            <span class="n">new_field_name</span> <span class="o">=</span> <span class="n">field_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                <span class="s1">&#39;uncorrected_&#39;</span><span class="p">,</span> <span class="s1">&#39;corrected_&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_field_name</span> <span class="o">=</span> <span class="s1">&#39;corrected_&#39;</span><span class="o">+</span><span class="n">field_name</span>
        <span class="n">new_dataset</span><span class="p">[</span><span class="s1">&#39;radar_out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="n">new_field_name</span><span class="p">,</span> <span class="n">radar_field</span><span class="p">)</span>


    <span class="k">if</span> <span class="ow">not</span> <span class="n">new_dataset</span><span class="p">[</span><span class="s1">&#39;radar_out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">new_dataset</span><span class="p">,</span> <span class="n">ind_rad</span></div>


<div class="viewcode-block" id="process_filter_vel_diff"><a class="viewcode-back" href="../../../proc.html#pyrad.proc.process_filter_vel_diff">[docs]</a><span class="k">def</span> <span class="nf">process_filter_vel_diff</span><span class="p">(</span><span class="n">procstatus</span><span class="p">,</span> <span class="n">dscfg</span><span class="p">,</span> <span class="n">radar_list</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    filters out range gates that could not be used for Doppler velocity</span>
<span class="sd">    estimation</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    procstatus : int</span>
<span class="sd">        Processing status: 0 initializing, 1 processing volume,</span>
<span class="sd">        2 post-processing</span>
<span class="sd">    dscfg : dictionary of dictionaries</span>
<span class="sd">        data set configuration. Accepted Configuration Keywords::</span>

<span class="sd">        datatype : list of string. Dataset keyword</span>
<span class="sd">            The input data types</span>
<span class="sd">        SNRmin : float. Dataset keyword</span>
<span class="sd">            The minimum SNR to keep the data.</span>
<span class="sd">    radar_list : list of Radar objects</span>
<span class="sd">        Optional. list of radar objects</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    new_dataset : dict</span>
<span class="sd">        dictionary containing the output</span>
<span class="sd">    ind_rad : int</span>
<span class="sd">        radar index</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">procstatus</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">datatypedescr</span> <span class="ow">in</span> <span class="n">dscfg</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]:</span>
        <span class="n">radarnr</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">datatype</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_datatype_fields</span><span class="p">(</span><span class="n">datatypedescr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;diffV&#39;</span><span class="p">:</span>
            <span class="n">vel_diff_field</span> <span class="o">=</span> <span class="n">get_fieldname_pyart</span><span class="p">(</span><span class="n">datatype</span><span class="p">)</span>
            <span class="k">break</span>

    <span class="n">ind_rad</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">radarnr</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">8</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span>
    <span class="k">if</span> <span class="n">radar_list</span><span class="p">[</span><span class="n">ind_rad</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;No valid radar&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">radar</span> <span class="o">=</span> <span class="n">radar_list</span><span class="p">[</span><span class="n">ind_rad</span><span class="p">]</span>

    <span class="n">new_dataset</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;radar_out&#39;</span><span class="p">:</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">radar</span><span class="p">)}</span>
    <span class="n">new_dataset</span><span class="p">[</span><span class="s1">&#39;radar_out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">vel_diff_field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">radar</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
        <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Unable to filter dataset according to valid velocity. &#39;</span> <span class="o">+</span>
             <span class="s1">&#39;Missing velocity differences field&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">getmaskarray</span><span class="p">(</span><span class="n">radar</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">vel_diff_field</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">datatypedescr</span> <span class="ow">in</span> <span class="n">dscfg</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]:</span>
        <span class="n">radarnr</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">datatype</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_datatype_fields</span><span class="p">(</span><span class="n">datatypedescr</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;diffV&#39;</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">field_name</span> <span class="o">=</span> <span class="n">get_fieldname_pyart</span><span class="p">(</span><span class="n">datatype</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">field_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">radar</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Unable to filter &#39;</span><span class="o">+</span><span class="n">field_name</span> <span class="o">+</span>
                 <span class="s1">&#39; according to SNR. &#39;</span><span class="o">+</span><span class="s1">&#39;No valid input fields&#39;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">radar_field</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">radar</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">])</span>
        <span class="n">radar_field</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">radar_field</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">field_name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;corrected_&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">new_field_name</span> <span class="o">=</span> <span class="n">field_name</span>
        <span class="k">elif</span> <span class="n">field_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;uncorrected_&#39;</span><span class="p">):</span>
            <span class="n">new_field_name</span> <span class="o">=</span> <span class="n">field_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                <span class="s1">&#39;uncorrected_&#39;</span><span class="p">,</span> <span class="s1">&#39;corrected_&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_field_name</span> <span class="o">=</span> <span class="s1">&#39;corrected_&#39;</span><span class="o">+</span><span class="n">field_name</span>
        <span class="n">new_dataset</span><span class="p">[</span><span class="s1">&#39;radar_out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="n">new_field_name</span><span class="p">,</span> <span class="n">radar_field</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">new_dataset</span><span class="p">[</span><span class="s1">&#39;radar_out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">new_dataset</span><span class="p">,</span> <span class="n">ind_rad</span></div>


<div class="viewcode-block" id="process_filter_visibility"><a class="viewcode-back" href="../../../proc.html#pyrad.proc.process_filter_visibility">[docs]</a><span class="k">def</span> <span class="nf">process_filter_visibility</span><span class="p">(</span><span class="n">procstatus</span><span class="p">,</span> <span class="n">dscfg</span><span class="p">,</span> <span class="n">radar_list</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    filters out rays gates with low visibility and corrects the reflectivity</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    procstatus : int</span>
<span class="sd">        Processing status: 0 initializing, 1 processing volume,</span>
<span class="sd">        2 post-processing</span>
<span class="sd">    dscfg : dictionary of dictionaries</span>
<span class="sd">        data set configuration. Accepted Configuration Keywords::</span>

<span class="sd">        datatype : list of string. Dataset keyword</span>
<span class="sd">            The input data types</span>
<span class="sd">        VISmin : float. Dataset keyword</span>
<span class="sd">            The minimum visibility to keep the data.</span>
<span class="sd">    radar_list : list of Radar objects</span>
<span class="sd">        Optional. list of radar objects</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    new_dataset : dict</span>
<span class="sd">        dictionary containing the output</span>
<span class="sd">    ind_rad : int</span>
<span class="sd">        radar index</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">procstatus</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">datatypedescr</span> <span class="ow">in</span> <span class="n">dscfg</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]:</span>
        <span class="n">radarnr</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">datatype</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_datatype_fields</span><span class="p">(</span><span class="n">datatypedescr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;VIS&#39;</span><span class="p">:</span>
            <span class="n">vis_field</span> <span class="o">=</span> <span class="n">get_fieldname_pyart</span><span class="p">(</span><span class="n">datatype</span><span class="p">)</span>
            <span class="k">break</span>

    <span class="n">ind_rad</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">radarnr</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">8</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span>
    <span class="k">if</span> <span class="n">radar_list</span><span class="p">[</span><span class="n">ind_rad</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;No valid radar&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">radar</span> <span class="o">=</span> <span class="n">radar_list</span><span class="p">[</span><span class="n">ind_rad</span><span class="p">]</span>

    <span class="n">new_dataset</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;radar_out&#39;</span><span class="p">:</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">radar</span><span class="p">)}</span>
    <span class="n">new_dataset</span><span class="p">[</span><span class="s1">&#39;radar_out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">vis_field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">radar</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
        <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Unable to filter dataset according to visibility. &#39;</span> <span class="o">+</span>
             <span class="s1">&#39;Missing visibility field&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="n">gatefilter</span> <span class="o">=</span> <span class="n">pyart</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">visibility_based_gate_filter</span><span class="p">(</span>
        <span class="n">radar</span><span class="p">,</span> <span class="n">vis_field</span><span class="o">=</span><span class="n">vis_field</span><span class="p">,</span> <span class="n">min_vis</span><span class="o">=</span><span class="n">dscfg</span><span class="p">[</span><span class="s1">&#39;VISmin&#39;</span><span class="p">])</span>
    <span class="n">is_lowVIS</span> <span class="o">=</span> <span class="n">gatefilter</span><span class="o">.</span><span class="n">gate_excluded</span> <span class="o">==</span> <span class="mi">1</span>

    <span class="k">for</span> <span class="n">datatypedescr</span> <span class="ow">in</span> <span class="n">dscfg</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">datatype</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_datatype_fields</span><span class="p">(</span>
            <span class="n">datatypedescr</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;VIS&#39;</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">field_name</span> <span class="o">=</span> <span class="n">get_fieldname_pyart</span><span class="p">(</span><span class="n">datatype</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">field_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">radar</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Unable to filter &#39;</span><span class="o">+</span><span class="n">field_name</span> <span class="o">+</span>
                 <span class="s1">&#39; according to visibility. No valid input fields&#39;</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">radar_aux</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">radar</span><span class="p">)</span>
        <span class="n">radar_aux</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span>
            <span class="n">is_lowVIS</span><span class="p">,</span> <span class="n">radar_aux</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">datatype</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;dBZ&#39;</span><span class="p">,</span> <span class="s1">&#39;dBZc&#39;</span><span class="p">,</span> <span class="s1">&#39;dBuZ&#39;</span><span class="p">,</span> <span class="s1">&#39;dBZv&#39;</span><span class="p">,</span> <span class="s1">&#39;dBZvc&#39;</span><span class="p">,</span> <span class="s1">&#39;dBuZv&#39;</span><span class="p">):</span>
            <span class="n">radar_field</span> <span class="o">=</span> <span class="n">pyart</span><span class="o">.</span><span class="n">correct</span><span class="o">.</span><span class="n">correct_visibility</span><span class="p">(</span>
                <span class="n">radar_aux</span><span class="p">,</span> <span class="n">vis_field</span><span class="o">=</span><span class="n">vis_field</span><span class="p">,</span> <span class="n">field_name</span><span class="o">=</span><span class="n">field_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">radar_field</span> <span class="o">=</span> <span class="n">radar_aux</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">field_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;corrected_&#39;</span><span class="p">):</span>
            <span class="n">new_field_name</span> <span class="o">=</span> <span class="n">field_name</span>
        <span class="k">elif</span> <span class="n">field_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;uncorrected_&#39;</span><span class="p">):</span>
            <span class="n">new_field_name</span> <span class="o">=</span> <span class="n">field_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                <span class="s1">&#39;uncorrected_&#39;</span><span class="p">,</span> <span class="s1">&#39;corrected_&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_field_name</span> <span class="o">=</span> <span class="s1">&#39;corrected_&#39;</span><span class="o">+</span><span class="n">field_name</span>
        <span class="n">new_dataset</span><span class="p">[</span><span class="s1">&#39;radar_out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="n">new_field_name</span><span class="p">,</span> <span class="n">radar_field</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">new_dataset</span><span class="p">[</span><span class="s1">&#39;radar_out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">new_dataset</span><span class="p">,</span> <span class="n">ind_rad</span></div>


<div class="viewcode-block" id="process_outlier_filter"><a class="viewcode-back" href="../../../proc.html#pyrad.proc.process_outlier_filter">[docs]</a><span class="k">def</span> <span class="nf">process_outlier_filter</span><span class="p">(</span><span class="n">procstatus</span><span class="p">,</span> <span class="n">dscfg</span><span class="p">,</span> <span class="n">radar_list</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    filters out gates which are outliers respect to the surrounding</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    procstatus : int</span>
<span class="sd">        Processing status: 0 initializing, 1 processing volume,</span>
<span class="sd">        2 post-processing</span>
<span class="sd">    dscfg : dictionary of dictionaries</span>
<span class="sd">        data set configuration. Accepted Configuration Keywords::</span>

<span class="sd">        datatype : list of string. Dataset keyword</span>
<span class="sd">            The input data types</span>
<span class="sd">        threshold : float. Dataset keyword</span>
<span class="sd">            The distance between the value of the examined range gate and the</span>
<span class="sd">            median of the surrounding gates to consider the gate an outlier</span>
<span class="sd">        nb : int. Dataset keyword</span>
<span class="sd">            The number of neighbours (to one side) to analyse. i.e. 2 would</span>
<span class="sd">            correspond to 24 gates</span>
<span class="sd">        nb_min : int. Dataset keyword</span>
<span class="sd">            Minimum number of neighbouring gates to consider the examined gate</span>
<span class="sd">            valid</span>
<span class="sd">        percentile_min, percentile_max : float. Dataset keyword</span>
<span class="sd">            gates below (above) these percentiles (computed over the sweep) are</span>
<span class="sd">            considered potential outliers and further examined</span>
<span class="sd">    radar_list : list of Radar objects</span>
<span class="sd">        Optional. list of radar objects</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    new_dataset : dict</span>
<span class="sd">        dictionary containing the output</span>
<span class="sd">    ind_rad : int</span>
<span class="sd">        radar index</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">procstatus</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="n">radarnr</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">datatype</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_datatype_fields</span><span class="p">(</span>
        <span class="n">dscfg</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

    <span class="n">ind_rad</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">radarnr</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">8</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span>
    <span class="k">if</span> <span class="n">radar_list</span><span class="p">[</span><span class="n">ind_rad</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;No valid radar&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">radar</span> <span class="o">=</span> <span class="n">radar_list</span><span class="p">[</span><span class="n">ind_rad</span><span class="p">]</span>

    <span class="n">field_name</span> <span class="o">=</span> <span class="n">get_fieldname_pyart</span><span class="p">(</span><span class="n">datatype</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">field_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">radar</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
        <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Unable to perform outlier removal. No valid data&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="n">threshold</span> <span class="o">=</span> <span class="n">dscfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;threshold&#39;</span><span class="p">,</span> <span class="mf">10.</span><span class="p">)</span>
    <span class="n">nb</span> <span class="o">=</span> <span class="n">dscfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nb&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">nb_min</span> <span class="o">=</span> <span class="n">dscfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nb_min&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">percentile_min</span> <span class="o">=</span> <span class="n">dscfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;percentile_min&#39;</span><span class="p">,</span> <span class="mf">5.</span><span class="p">)</span>
    <span class="n">percentile_max</span> <span class="o">=</span> <span class="n">dscfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;percentile_max&#39;</span><span class="p">,</span> <span class="mf">95.</span><span class="p">)</span>

    <span class="n">field</span> <span class="o">=</span> <span class="n">radar</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span>
    <span class="n">field_out</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">sweep</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">radar</span><span class="o">.</span><span class="n">nsweeps</span><span class="p">):</span>
        <span class="c1"># find gates suspected to be outliers</span>
        <span class="n">sweep_start</span> <span class="o">=</span> <span class="n">radar</span><span class="o">.</span><span class="n">sweep_start_ray_index</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">sweep</span><span class="p">]</span>
        <span class="n">sweep_end</span> <span class="o">=</span> <span class="n">radar</span><span class="o">.</span><span class="n">sweep_end_ray_index</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">sweep</span><span class="p">]</span>
        <span class="n">nrays_sweep</span> <span class="o">=</span> <span class="n">radar</span><span class="o">.</span><span class="n">rays_per_sweep</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">sweep</span><span class="p">]</span>
        <span class="n">data_sweep</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">sweep_start</span><span class="p">:</span><span class="n">sweep_end</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span>

        <span class="c1"># check if all elements in array are masked</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">getmaskarray</span><span class="p">(</span><span class="n">data_sweep</span><span class="p">)):</span>
            <span class="k">continue</span>

        <span class="n">percent_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanpercentile</span><span class="p">(</span>
            <span class="n">data_sweep</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="n">fill_value</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">),</span>
            <span class="p">(</span><span class="n">percentile_min</span><span class="p">,</span> <span class="n">percentile_max</span><span class="p">))</span>
        <span class="n">ind_rays</span><span class="p">,</span> <span class="n">ind_rngs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span>
                <span class="n">data_sweep</span> <span class="o">&lt;</span> <span class="n">percent_vals</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data_sweep</span> <span class="o">&gt;</span> <span class="n">percent_vals</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ind_ray</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ind_rays</span><span class="p">):</span>
            <span class="n">ind_rng</span> <span class="o">=</span> <span class="n">ind_rngs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="c1"># find neighbours of suspected outlier gate</span>
            <span class="n">data_cube</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ray_nb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="n">nb</span><span class="p">,</span> <span class="n">nb</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">rng_nb</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="n">nb</span><span class="p">,</span> <span class="n">nb</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">ray_nb</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">rng_nb</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="p">((</span><span class="n">ind_ray</span><span class="o">+</span><span class="n">ray_nb</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span>
                            <span class="p">(</span><span class="n">ind_ray</span><span class="o">+</span><span class="n">ray_nb</span> <span class="o">&lt;</span> <span class="n">nrays_sweep</span><span class="p">)</span> <span class="ow">and</span>
                            <span class="p">(</span><span class="n">ind_rng</span><span class="o">+</span><span class="n">rng_nb</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span>
                            <span class="p">(</span><span class="n">ind_rng</span><span class="o">+</span><span class="n">rng_nb</span> <span class="o">&lt;</span> <span class="n">radar</span><span class="o">.</span><span class="n">ngates</span><span class="p">)):</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">data_sweep</span><span class="p">[</span><span class="n">ind_ray</span><span class="o">+</span><span class="n">ray_nb</span><span class="p">,</span> <span class="n">ind_rng</span><span class="o">+</span><span class="n">rng_nb</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span><span class="p">):</span>
                            <span class="n">data_cube</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="n">data_sweep</span><span class="p">[</span><span class="n">ind_ray</span><span class="o">+</span><span class="n">ray_nb</span><span class="p">,</span> <span class="n">ind_rng</span><span class="o">+</span><span class="n">rng_nb</span><span class="p">])</span>

            <span class="c1"># remove data far from median of neighbours or with not enough</span>
            <span class="c1"># valid neighbours</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_cube</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">nb_min</span><span class="p">:</span>
                <span class="n">field_out</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span>
                    <span class="n">sweep_start</span><span class="o">+</span><span class="n">ind_ray</span><span class="p">,</span> <span class="n">ind_rng</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
            <span class="k">elif</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">data_cube</span><span class="p">)</span> <span class="o">-</span>
                      <span class="n">data_sweep</span><span class="p">[</span><span class="n">ind_ray</span><span class="p">,</span> <span class="n">ind_rng</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">):</span>
                <span class="n">field_out</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">sweep_start</span><span class="o">+</span><span class="n">ind_ray</span><span class="p">,</span> <span class="n">ind_rng</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>

    <span class="k">if</span> <span class="n">field_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;corrected_&#39;</span><span class="p">):</span>
        <span class="n">new_field_name</span> <span class="o">=</span> <span class="n">field_name</span>
    <span class="k">elif</span> <span class="n">field_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;uncorrected_&#39;</span><span class="p">):</span>
        <span class="n">new_field_name</span> <span class="o">=</span> <span class="n">field_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="s1">&#39;uncorrected_&#39;</span><span class="p">,</span> <span class="s1">&#39;corrected_&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">new_field_name</span> <span class="o">=</span> <span class="s1">&#39;corrected_&#39;</span><span class="o">+</span><span class="n">field_name</span>

    <span class="n">new_dataset</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;radar_out&#39;</span><span class="p">:</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">radar</span><span class="p">)}</span>
    <span class="n">new_dataset</span><span class="p">[</span><span class="s1">&#39;radar_out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">new_dataset</span><span class="p">[</span><span class="s1">&#39;radar_out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="n">new_field_name</span><span class="p">,</span> <span class="n">field_out</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">new_dataset</span><span class="p">,</span> <span class="n">ind_rad</span></div>


<div class="viewcode-block" id="process_hydroclass"><a class="viewcode-back" href="../../../proc.html#pyrad.proc.process_hydroclass">[docs]</a><span class="k">def</span> <span class="nf">process_hydroclass</span><span class="p">(</span><span class="n">procstatus</span><span class="p">,</span> <span class="n">dscfg</span><span class="p">,</span> <span class="n">radar_list</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Classifies precipitation echoes</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    procstatus : int</span>
<span class="sd">        Processing status: 0 initializing, 1 processing volume,</span>
<span class="sd">        2 post-processing</span>
<span class="sd">    dscfg : dictionary of dictionaries</span>
<span class="sd">        data set configuration. Accepted Configuration Keywords::</span>

<span class="sd">        datatype : list of string. Dataset keyword</span>
<span class="sd">            The input data types</span>
<span class="sd">        HYDRO_METHOD : string. Dataset keyword</span>
<span class="sd">            The hydrometeor classification method. One of the following:</span>
<span class="sd">            SEMISUPERVISED</span>
<span class="sd">        RADARCENTROIDS : string. Datset keyword</span>
<span class="sd">            Used with HYDRO_METHOD SEMISUPERVISED. The name of the radar of</span>
<span class="sd">            which the derived centroids will be used. One of the following: A</span>
<span class="sd">            Albis, L Lema, P Plaine Morte, DX50</span>
<span class="sd">    radar_list : list of Radar objects</span>
<span class="sd">        Optional. list of radar objects</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    new_dataset : dict</span>
<span class="sd">        dictionary containing the output</span>
<span class="sd">    ind_rad : int</span>
<span class="sd">        radar index</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">procstatus</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="s1">&#39;HYDRO_METHOD&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dscfg</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
            <span class="s2">&quot;ERROR: Undefined parameter &#39;HYDRO_METHOD&#39; for dataset &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span>
            <span class="o">%</span> <span class="n">dscfg</span><span class="p">[</span><span class="s1">&#39;dsname&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">dscfg</span><span class="p">[</span><span class="s1">&#39;HYDRO_METHOD&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;SEMISUPERVISED&#39;</span><span class="p">:</span>
        <span class="n">temp_field</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">iso0_field</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">datatypedescr</span> <span class="ow">in</span> <span class="n">dscfg</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]:</span>
            <span class="n">radarnr</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">datatype</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_datatype_fields</span><span class="p">(</span><span class="n">datatypedescr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;dBZ&#39;</span><span class="p">:</span>
                <span class="n">refl_field</span> <span class="o">=</span> <span class="s1">&#39;reflectivity&#39;</span>
            <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;dBZc&#39;</span><span class="p">:</span>
                <span class="n">refl_field</span> <span class="o">=</span> <span class="s1">&#39;corrected_reflectivity&#39;</span>
            <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;ZDR&#39;</span><span class="p">:</span>
                <span class="n">zdr_field</span> <span class="o">=</span> <span class="s1">&#39;differential_reflectivity&#39;</span>
            <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;ZDRc&#39;</span><span class="p">:</span>
                <span class="n">zdr_field</span> <span class="o">=</span> <span class="s1">&#39;corrected_differential_reflectivity&#39;</span>
            <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;RhoHV&#39;</span><span class="p">:</span>
                <span class="n">rhv_field</span> <span class="o">=</span> <span class="s1">&#39;cross_correlation_ratio&#39;</span>
            <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;uRhoHV&#39;</span><span class="p">:</span>
                <span class="n">rhv_field</span> <span class="o">=</span> <span class="s1">&#39;uncorrected_cross_correlation_ratio&#39;</span>
            <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;RhoHVc&#39;</span><span class="p">:</span>
                <span class="n">rhv_field</span> <span class="o">=</span> <span class="s1">&#39;corrected_cross_correlation_ratio&#39;</span>
            <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;KDP&#39;</span><span class="p">:</span>
                <span class="n">kdp_field</span> <span class="o">=</span> <span class="s1">&#39;specific_differential_phase&#39;</span>
            <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;KDPc&#39;</span><span class="p">:</span>
                <span class="n">kdp_field</span> <span class="o">=</span> <span class="s1">&#39;corrected_specific_differential_phase&#39;</span>
            <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;TEMP&#39;</span><span class="p">:</span>
                <span class="n">temp_field</span> <span class="o">=</span> <span class="s1">&#39;temperature&#39;</span>
            <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;H_ISO0&#39;</span><span class="p">:</span>
                <span class="n">iso0_field</span> <span class="o">=</span> <span class="s1">&#39;height_over_iso0&#39;</span>

        <span class="n">ind_rad</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">radarnr</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">8</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">radar_list</span><span class="p">[</span><span class="n">ind_rad</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;No valid radar&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="n">radar</span> <span class="o">=</span> <span class="n">radar_list</span><span class="p">[</span><span class="n">ind_rad</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">temp_field</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">iso0_field</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;iso0 or temperature fields needed to create hydrometeor &#39;</span> <span class="o">+</span>
                 <span class="s1">&#39;classification field&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">temp_field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">temp_field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">radar</span><span class="o">.</span><span class="n">fields</span><span class="p">):</span>
            <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Unable to create hydrometeor classification field. &#39;</span> <span class="o">+</span>
                 <span class="s1">&#39;Missing temperature field&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">iso0_field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">iso0_field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">radar</span><span class="o">.</span><span class="n">fields</span><span class="p">):</span>
            <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Unable to create hydrometeor classification field. &#39;</span> <span class="o">+</span>
                 <span class="s1">&#39;Missing height over iso0 field&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="n">temp_ref</span> <span class="o">=</span> <span class="s1">&#39;temperature&#39;</span>
        <span class="k">if</span> <span class="n">iso0_field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">temp_ref</span> <span class="o">=</span> <span class="s1">&#39;height_over_iso0&#39;</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">refl_field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">radar</span><span class="o">.</span><span class="n">fields</span><span class="p">)</span> <span class="ow">or</span>
                <span class="p">(</span><span class="n">zdr_field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">radar</span><span class="o">.</span><span class="n">fields</span><span class="p">)</span> <span class="ow">or</span>
                <span class="p">(</span><span class="n">rhv_field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">radar</span><span class="o">.</span><span class="n">fields</span><span class="p">)</span> <span class="ow">or</span>
                <span class="p">(</span><span class="n">kdp_field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">radar</span><span class="o">.</span><span class="n">fields</span><span class="p">)):</span>
            <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Unable to create hydrometeor classification field. &#39;</span> <span class="o">+</span>
                 <span class="s1">&#39;Missing data&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="n">mass_centers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">9</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">dscfg</span><span class="p">[</span><span class="s1">&#39;RADARCENTROIDS&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;A&#39;</span><span class="p">:</span>
            <span class="c1">#      Zh      ZDR     kdp   RhoHV   delta_Z</span>
            <span class="n">mass_centers</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">13.5829</span><span class="p">,</span> <span class="mf">0.4063</span><span class="p">,</span> <span class="mf">0.0497</span><span class="p">,</span> <span class="mf">0.9868</span><span class="p">,</span> <span class="mf">1330.3</span><span class="p">]</span>  <span class="c1"># AG</span>
            <span class="n">mass_centers</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">02.8453</span><span class="p">,</span> <span class="mf">0.2457</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">0.9798</span><span class="p">,</span> <span class="mf">0653.8</span><span class="p">]</span>  <span class="c1"># CR</span>
            <span class="n">mass_centers</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">07.6597</span><span class="p">,</span> <span class="mf">0.2180</span><span class="p">,</span> <span class="mf">0.0019</span><span class="p">,</span> <span class="mf">0.9799</span><span class="p">,</span> <span class="o">-</span><span class="mf">1426.5</span><span class="p">]</span>  <span class="c1"># LR</span>
            <span class="n">mass_centers</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">31.6815</span><span class="p">,</span> <span class="mf">0.3926</span><span class="p">,</span> <span class="mf">0.0828</span><span class="p">,</span> <span class="mf">0.9978</span><span class="p">,</span> <span class="mf">0535.3</span><span class="p">]</span>  <span class="c1"># RP</span>
            <span class="n">mass_centers</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">39.4703</span><span class="p">,</span> <span class="mf">1.0734</span><span class="p">,</span> <span class="mf">0.4919</span><span class="p">,</span> <span class="mf">0.9876</span><span class="p">,</span> <span class="o">-</span><span class="mf">1036.3</span><span class="p">]</span>  <span class="c1"># RN</span>
            <span class="n">mass_centers</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">04.8267</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5690</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">0.9691</span><span class="p">,</span> <span class="mf">0869.8</span><span class="p">]</span>  <span class="c1"># VI</span>
            <span class="n">mass_centers</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">30.8613</span><span class="p">,</span> <span class="mf">0.9819</span><span class="p">,</span> <span class="mf">0.1998</span><span class="p">,</span> <span class="mf">0.9845</span><span class="p">,</span> <span class="o">-</span><span class="mf">0066.1</span><span class="p">]</span>  <span class="c1"># WS</span>
            <span class="n">mass_centers</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">52.3969</span><span class="p">,</span> <span class="mf">2.1094</span><span class="p">,</span> <span class="mf">2.4675</span><span class="p">,</span> <span class="mf">0.9730</span><span class="p">,</span> <span class="o">-</span><span class="mf">1550.2</span><span class="p">]</span>  <span class="c1"># MH</span>
            <span class="n">mass_centers</span><span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">50.6186</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.0649</span><span class="p">,</span> <span class="mf">0.0946</span><span class="p">,</span> <span class="mf">0.9904</span><span class="p">,</span> <span class="mf">1179.9</span><span class="p">]</span>  <span class="c1"># IH/HDG</span>
        <span class="k">elif</span> <span class="n">dscfg</span><span class="p">[</span><span class="s1">&#39;RADARCENTROIDS&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;L&#39;</span><span class="p">:</span>
            <span class="c1">#       Zh      ZDR     kdp   RhoHV   delta_Z</span>
            <span class="n">mass_centers</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">13.8231</span><span class="p">,</span> <span class="mf">0.2514</span><span class="p">,</span> <span class="mf">0.0644</span><span class="p">,</span> <span class="mf">0.9861</span><span class="p">,</span> <span class="mf">1380.6</span><span class="p">]</span>  <span class="c1"># AG</span>
            <span class="n">mass_centers</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">03.0239</span><span class="p">,</span> <span class="mf">0.1971</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">0.9661</span><span class="p">,</span> <span class="mf">1464.1</span><span class="p">]</span>  <span class="c1"># CR</span>
            <span class="n">mass_centers</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">04.9447</span><span class="p">,</span> <span class="mf">0.1142</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">0.9787</span><span class="p">,</span> <span class="o">-</span><span class="mf">0974.7</span><span class="p">]</span>  <span class="c1"># LR</span>
            <span class="n">mass_centers</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">34.2450</span><span class="p">,</span> <span class="mf">0.5540</span><span class="p">,</span> <span class="mf">0.1459</span><span class="p">,</span> <span class="mf">0.9937</span><span class="p">,</span> <span class="mf">0945.3</span><span class="p">]</span>  <span class="c1"># RP</span>
            <span class="n">mass_centers</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">40.9432</span><span class="p">,</span> <span class="mf">1.0110</span><span class="p">,</span> <span class="mf">0.5141</span><span class="p">,</span> <span class="mf">0.9928</span><span class="p">,</span> <span class="o">-</span><span class="mf">0993.5</span><span class="p">]</span>  <span class="c1"># RN</span>
            <span class="n">mass_centers</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">03.5202</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3498</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">0.9746</span><span class="p">,</span> <span class="mf">0843.2</span><span class="p">]</span>  <span class="c1"># VI</span>
            <span class="n">mass_centers</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">32.5287</span><span class="p">,</span> <span class="mf">0.9751</span><span class="p">,</span> <span class="mf">0.2640</span><span class="p">,</span> <span class="mf">0.9804</span><span class="p">,</span> <span class="o">-</span><span class="mf">0055.5</span><span class="p">]</span>  <span class="c1"># WS</span>
            <span class="n">mass_centers</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">52.6547</span><span class="p">,</span> <span class="mf">2.7054</span><span class="p">,</span> <span class="mf">2.5101</span><span class="p">,</span> <span class="mf">0.9765</span><span class="p">,</span> <span class="o">-</span><span class="mf">1114.6</span><span class="p">]</span>  <span class="c1"># MH</span>
            <span class="n">mass_centers</span><span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">46.4998</span><span class="p">,</span> <span class="mf">0.1978</span><span class="p">,</span> <span class="mf">0.6431</span><span class="p">,</span> <span class="mf">0.9845</span><span class="p">,</span> <span class="mf">1010.1</span><span class="p">]</span>  <span class="c1"># IH/HDG</span>
        <span class="k">elif</span> <span class="n">dscfg</span><span class="p">[</span><span class="s1">&#39;RADARCENTROIDS&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;D&#39;</span><span class="p">:</span>
            <span class="c1">#       Zh      ZDR     kdp   RhoHV   delta_Z</span>
            <span class="n">mass_centers</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">12.567</span><span class="p">,</span> <span class="mf">0.18934</span><span class="p">,</span> <span class="mf">0.041193</span><span class="p">,</span> <span class="mf">0.97693</span><span class="p">,</span> <span class="mf">1328.1</span><span class="p">]</span>  <span class="c1"># AG</span>
            <span class="n">mass_centers</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">3.2115</span><span class="p">,</span> <span class="mf">0.13379</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">0.96918</span><span class="p">,</span> <span class="mf">1406.3</span><span class="p">]</span>  <span class="c1"># CR</span>
            <span class="n">mass_centers</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">10.669</span><span class="p">,</span> <span class="mf">0.18119</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">0.97337</span><span class="p">,</span> <span class="o">-</span><span class="mf">1171.9</span><span class="p">]</span>  <span class="c1"># LR</span>
            <span class="n">mass_centers</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">34.941</span><span class="p">,</span> <span class="mf">0.13301</span><span class="p">,</span> <span class="mf">0.090056</span><span class="p">,</span> <span class="mf">0.9979</span><span class="p">,</span> <span class="mf">898.44</span><span class="p">]</span>  <span class="c1"># RP</span>
            <span class="n">mass_centers</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">39.653</span><span class="p">,</span> <span class="mf">1.1432</span><span class="p">,</span> <span class="mf">0.35013</span><span class="p">,</span> <span class="mf">0.98501</span><span class="p">,</span> <span class="o">-</span><span class="mf">859.38</span><span class="p">]</span>  <span class="c1"># RN</span>
            <span class="n">mass_centers</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">2.8874</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.46363</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">0.95653</span><span class="p">,</span> <span class="mf">1015.6</span><span class="p">]</span>  <span class="c1"># VI</span>
            <span class="n">mass_centers</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">34.122</span><span class="p">,</span> <span class="mf">0.87987</span><span class="p">,</span> <span class="mf">0.2281</span><span class="p">,</span> <span class="mf">0.98003</span><span class="p">,</span> <span class="o">-</span><span class="mf">234.37</span><span class="p">]</span>  <span class="c1"># WS</span>
            <span class="n">mass_centers</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">53.134</span><span class="p">,</span> <span class="mf">2.0888</span><span class="p">,</span> <span class="mf">2.0055</span><span class="p">,</span> <span class="mf">0.96927</span><span class="p">,</span> <span class="o">-</span><span class="mf">1054.7</span><span class="p">]</span>  <span class="c1"># MH</span>
            <span class="n">mass_centers</span><span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">46.715</span><span class="p">,</span> <span class="mf">0.030477</span><span class="p">,</span> <span class="mf">0.16994</span><span class="p">,</span> <span class="mf">0.9969</span><span class="p">,</span> <span class="mf">976.56</span><span class="p">]</span>  <span class="c1"># IH/HDG</span>
        <span class="k">elif</span> <span class="n">dscfg</span><span class="p">[</span><span class="s1">&#39;RADARCENTROIDS&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;P&#39;</span><span class="p">:</span>
            <span class="c1">#       Zh      ZDR     kdp   RhoHV   delta_Z</span>
            <span class="n">mass_centers</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">13.9882</span><span class="p">,</span> <span class="mf">0.2470</span><span class="p">,</span> <span class="mf">0.0690</span><span class="p">,</span> <span class="mf">0.9939</span><span class="p">,</span> <span class="mf">1418.1</span><span class="p">]</span>  <span class="c1"># AG</span>
            <span class="n">mass_centers</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">00.9834</span><span class="p">,</span> <span class="mf">0.4830</span><span class="p">,</span> <span class="mf">0.0043</span><span class="p">,</span> <span class="mf">0.9834</span><span class="p">,</span> <span class="mf">0950.6</span><span class="p">]</span>  <span class="c1"># CR</span>
            <span class="n">mass_centers</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">05.3962</span><span class="p">,</span> <span class="mf">0.2689</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">0.9831</span><span class="p">,</span> <span class="o">-</span><span class="mf">0479.5</span><span class="p">]</span>  <span class="c1"># LR</span>
            <span class="n">mass_centers</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">35.3411</span><span class="p">,</span> <span class="mf">0.1502</span><span class="p">,</span> <span class="mf">0.0940</span><span class="p">,</span> <span class="mf">0.9974</span><span class="p">,</span> <span class="mf">0920.9</span><span class="p">]</span>  <span class="c1"># RP</span>
            <span class="n">mass_centers</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">35.0114</span><span class="p">,</span> <span class="mf">0.9681</span><span class="p">,</span> <span class="mf">0.1106</span><span class="p">,</span> <span class="mf">0.9785</span><span class="p">,</span> <span class="o">-</span><span class="mf">0374.0</span><span class="p">]</span>  <span class="c1"># RN</span>
            <span class="n">mass_centers</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">02.5897</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3879</span><span class="p">,</span> <span class="mf">0.0282</span><span class="p">,</span> <span class="mf">0.9876</span><span class="p">,</span> <span class="mf">0985.5</span><span class="p">]</span>  <span class="c1"># VI</span>
            <span class="n">mass_centers</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">32.2914</span><span class="p">,</span> <span class="mf">0.7789</span><span class="p">,</span> <span class="mf">0.1443</span><span class="p">,</span> <span class="mf">0.9075</span><span class="p">,</span> <span class="o">-</span><span class="mf">0153.5</span><span class="p">]</span>  <span class="c1"># WS</span>
            <span class="n">mass_centers</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">53.2413</span><span class="p">,</span> <span class="mf">1.8723</span><span class="p">,</span> <span class="mf">0.3857</span><span class="p">,</span> <span class="mf">0.9454</span><span class="p">,</span> <span class="o">-</span><span class="mf">0470.8</span><span class="p">]</span>  <span class="c1"># MH</span>
            <span class="n">mass_centers</span><span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">44.7896</span><span class="p">,</span> <span class="mf">0.0015</span><span class="p">,</span> <span class="mf">0.1349</span><span class="p">,</span> <span class="mf">0.9968</span><span class="p">,</span> <span class="mf">1116.7</span><span class="p">]</span>  <span class="c1"># IH/HDG</span>
        <span class="k">elif</span> <span class="n">dscfg</span><span class="p">[</span><span class="s1">&#39;RADARCENTROIDS&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;W&#39;</span><span class="p">:</span>
            <span class="c1">#       Zh      ZDR     kdp   RhoHV   delta_Z</span>
            <span class="n">mass_centers</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">16.7650</span><span class="p">,</span> <span class="mf">0.3754</span><span class="p">,</span> <span class="mf">0.0442</span><span class="p">,</span> <span class="mf">0.9866</span><span class="p">,</span> <span class="mf">1409.0</span><span class="p">]</span>  <span class="c1"># AG</span>
            <span class="n">mass_centers</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">01.4418</span><span class="p">,</span> <span class="mf">0.3786</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">0.9490</span><span class="p">,</span> <span class="mf">1415.8</span><span class="p">]</span>  <span class="c1"># CR</span>
            <span class="n">mass_centers</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">16.0987</span><span class="p">,</span> <span class="mf">0.3238</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">0.9871</span><span class="p">,</span> <span class="o">-</span><span class="mf">0818.7</span><span class="p">]</span>  <span class="c1"># LR</span>
            <span class="n">mass_centers</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">36.5465</span><span class="p">,</span> <span class="mf">0.2041</span><span class="p">,</span> <span class="mf">0.0731</span><span class="p">,</span> <span class="mf">0.9952</span><span class="p">,</span> <span class="mf">0745.4</span><span class="p">]</span>  <span class="c1"># RP</span>
            <span class="n">mass_centers</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">43.4011</span><span class="p">,</span> <span class="mf">0.6658</span><span class="p">,</span> <span class="mf">0.3241</span><span class="p">,</span> <span class="mf">0.9894</span><span class="p">,</span> <span class="o">-</span><span class="mf">0778.5</span><span class="p">]</span>  <span class="c1"># RN</span>
            <span class="n">mass_centers</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">00.9077</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.4793</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">0.9502</span><span class="p">,</span> <span class="mf">1488.6</span><span class="p">]</span>  <span class="c1"># VI</span>
            <span class="n">mass_centers</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">36.8091</span><span class="p">,</span> <span class="mf">0.7266</span><span class="p">,</span> <span class="mf">0.1284</span><span class="p">,</span> <span class="mf">0.9924</span><span class="p">,</span> <span class="o">-</span><span class="mf">0071.1</span><span class="p">]</span>  <span class="c1"># WS</span>
            <span class="n">mass_centers</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">53.8402</span><span class="p">,</span> <span class="mf">0.8922</span><span class="p">,</span> <span class="mf">0.5306</span><span class="p">,</span> <span class="mf">0.9890</span><span class="p">,</span> <span class="o">-</span><span class="mf">1017.6</span><span class="p">]</span>  <span class="c1"># MH</span>
            <span class="n">mass_centers</span><span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">45.9686</span><span class="p">,</span> <span class="mf">0.0845</span><span class="p">,</span> <span class="mf">0.0963</span><span class="p">,</span> <span class="mf">0.9940</span><span class="p">,</span> <span class="mf">0867.4</span><span class="p">]</span>  <span class="c1"># IH/HDG</span>
        <span class="k">elif</span> <span class="n">dscfg</span><span class="p">[</span><span class="s1">&#39;RADARCENTROIDS&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;DX50&#39;</span><span class="p">:</span>
            <span class="c1">#       Zh      ZDR     kdp   RhoHV   delta_Z</span>
            <span class="n">mass_centers</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">19.0770</span><span class="p">,</span> <span class="mf">0.4139</span><span class="p">,</span> <span class="mf">0.0099</span><span class="p">,</span> <span class="mf">0.9841</span><span class="p">,</span> <span class="mf">1061.7</span><span class="p">]</span>  <span class="c1"># AG</span>
            <span class="n">mass_centers</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">03.9877</span><span class="p">,</span> <span class="mf">0.5040</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">0.9642</span><span class="p">,</span> <span class="mf">0856.6</span><span class="p">]</span>  <span class="c1"># CR</span>
            <span class="n">mass_centers</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">20.7982</span><span class="p">,</span> <span class="mf">0.3177</span><span class="p">,</span> <span class="mf">0.0004</span><span class="p">,</span> <span class="mf">0.9858</span><span class="p">,</span> <span class="o">-</span><span class="mf">1375.1</span><span class="p">]</span>  <span class="c1"># LR</span>
            <span class="n">mass_centers</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">34.7124</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3748</span><span class="p">,</span> <span class="mf">0.0988</span><span class="p">,</span> <span class="mf">0.9828</span><span class="p">,</span> <span class="mf">1224.2</span><span class="p">]</span>  <span class="c1"># RP</span>
            <span class="n">mass_centers</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">33.0134</span><span class="p">,</span> <span class="mf">0.6614</span><span class="p">,</span> <span class="mf">0.0819</span><span class="p">,</span> <span class="mf">0.9802</span><span class="p">,</span> <span class="o">-</span><span class="mf">1169.8</span><span class="p">]</span>  <span class="c1"># RN</span>
            <span class="n">mass_centers</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">08.2610</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.4681</span><span class="p">,</span> <span class="mf">0.0000</span><span class="p">,</span> <span class="mf">0.9722</span><span class="p">,</span> <span class="mf">1100.7</span><span class="p">]</span>  <span class="c1"># VI</span>
            <span class="n">mass_centers</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">35.1801</span><span class="p">,</span> <span class="mf">1.2830</span><span class="p">,</span> <span class="mf">0.1322</span><span class="p">,</span> <span class="mf">0.9162</span><span class="p">,</span> <span class="o">-</span><span class="mf">0159.8</span><span class="p">]</span>  <span class="c1"># WS</span>
            <span class="n">mass_centers</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">52.4539</span><span class="p">,</span> <span class="mf">2.3714</span><span class="p">,</span> <span class="mf">1.1120</span><span class="p">,</span> <span class="mf">0.9382</span><span class="p">,</span> <span class="o">-</span><span class="mf">1618.5</span><span class="p">]</span>  <span class="c1"># MH</span>
            <span class="n">mass_centers</span><span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="mf">44.2216</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3419</span><span class="p">,</span> <span class="mf">0.0687</span><span class="p">,</span> <span class="mf">0.9683</span><span class="p">,</span> <span class="mf">1272.7</span><span class="p">]</span>  <span class="c1"># IH/HDG</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span>
                <span class="s1">&#39; Unknown radar. &#39;</span> <span class="o">+</span>
                <span class="s1">&#39;Default centroids will be used in classification.&#39;</span><span class="p">)</span>
            <span class="n">mass_centers</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">compute_entropy</span> <span class="o">=</span> <span class="n">dscfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;compute_entropy&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">output_distances</span> <span class="o">=</span> <span class="n">dscfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;output_distances&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">vectorize</span> <span class="o">=</span> <span class="n">dscfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;vectorize&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="n">fields_dict</span> <span class="o">=</span> <span class="n">pyart</span><span class="o">.</span><span class="n">retrieve</span><span class="o">.</span><span class="n">hydroclass_semisupervised</span><span class="p">(</span>
            <span class="n">radar</span><span class="p">,</span> <span class="n">mass_centers</span><span class="o">=</span><span class="n">mass_centers</span><span class="p">,</span>
            <span class="n">weights</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]),</span> <span class="n">refl_field</span><span class="o">=</span><span class="n">refl_field</span><span class="p">,</span>
            <span class="n">zdr_field</span><span class="o">=</span><span class="n">zdr_field</span><span class="p">,</span> <span class="n">rhv_field</span><span class="o">=</span><span class="n">rhv_field</span><span class="p">,</span> <span class="n">kdp_field</span><span class="o">=</span><span class="n">kdp_field</span><span class="p">,</span>
            <span class="n">temp_field</span><span class="o">=</span><span class="n">temp_field</span><span class="p">,</span> <span class="n">iso0_field</span><span class="o">=</span><span class="n">iso0_field</span><span class="p">,</span> <span class="n">hydro_field</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">entropy_field</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">temp_ref</span><span class="o">=</span><span class="n">temp_ref</span><span class="p">,</span>
            <span class="n">compute_entropy</span><span class="o">=</span><span class="n">compute_entropy</span><span class="p">,</span>
            <span class="n">output_distances</span><span class="o">=</span><span class="n">output_distances</span><span class="p">,</span> <span class="n">vectorize</span><span class="o">=</span><span class="n">vectorize</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
            <span class="s2">&quot;ERROR: Unknown hydrometeor classification method &quot;</span> <span class="o">+</span>
            <span class="n">dscfg</span><span class="p">[</span><span class="s1">&#39;HYDRO_METHOD&#39;</span><span class="p">])</span>

    <span class="c1"># prepare for exit</span>
    <span class="n">new_dataset</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;radar_out&#39;</span><span class="p">:</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">radar</span><span class="p">)}</span>
    <span class="n">new_dataset</span><span class="p">[</span><span class="s1">&#39;radar_out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">new_dataset</span><span class="p">[</span><span class="s1">&#39;radar_out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span>
        <span class="s1">&#39;radar_echo_classification&#39;</span><span class="p">,</span> <span class="n">fields_dict</span><span class="p">[</span><span class="s1">&#39;hydro&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">compute_entropy</span><span class="p">:</span>
        <span class="n">new_dataset</span><span class="p">[</span><span class="s1">&#39;radar_out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span>
            <span class="s1">&#39;hydroclass_entropy&#39;</span><span class="p">,</span> <span class="n">fields_dict</span><span class="p">[</span><span class="s1">&#39;entropy&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">output_distances</span><span class="p">:</span>
            <span class="n">new_dataset</span><span class="p">[</span><span class="s1">&#39;radar_out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span>
                <span class="s1">&#39;proportion_AG&#39;</span><span class="p">,</span> <span class="n">fields_dict</span><span class="p">[</span><span class="s1">&#39;prop_AG&#39;</span><span class="p">])</span>
            <span class="n">new_dataset</span><span class="p">[</span><span class="s1">&#39;radar_out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span>
                <span class="s1">&#39;proportion_CR&#39;</span><span class="p">,</span> <span class="n">fields_dict</span><span class="p">[</span><span class="s1">&#39;prop_CR&#39;</span><span class="p">])</span>
            <span class="n">new_dataset</span><span class="p">[</span><span class="s1">&#39;radar_out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span>
                <span class="s1">&#39;proportion_LR&#39;</span><span class="p">,</span> <span class="n">fields_dict</span><span class="p">[</span><span class="s1">&#39;prop_LR&#39;</span><span class="p">])</span>
            <span class="n">new_dataset</span><span class="p">[</span><span class="s1">&#39;radar_out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span>
                <span class="s1">&#39;proportion_RP&#39;</span><span class="p">,</span> <span class="n">fields_dict</span><span class="p">[</span><span class="s1">&#39;prop_RP&#39;</span><span class="p">])</span>
            <span class="n">new_dataset</span><span class="p">[</span><span class="s1">&#39;radar_out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span>
                <span class="s1">&#39;proportion_RN&#39;</span><span class="p">,</span> <span class="n">fields_dict</span><span class="p">[</span><span class="s1">&#39;prop_RN&#39;</span><span class="p">])</span>
            <span class="n">new_dataset</span><span class="p">[</span><span class="s1">&#39;radar_out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span>
                <span class="s1">&#39;proportion_VI&#39;</span><span class="p">,</span> <span class="n">fields_dict</span><span class="p">[</span><span class="s1">&#39;prop_VI&#39;</span><span class="p">])</span>
            <span class="n">new_dataset</span><span class="p">[</span><span class="s1">&#39;radar_out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span>
                <span class="s1">&#39;proportion_WS&#39;</span><span class="p">,</span> <span class="n">fields_dict</span><span class="p">[</span><span class="s1">&#39;prop_WS&#39;</span><span class="p">])</span>
            <span class="n">new_dataset</span><span class="p">[</span><span class="s1">&#39;radar_out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span>
                <span class="s1">&#39;proportion_MH&#39;</span><span class="p">,</span> <span class="n">fields_dict</span><span class="p">[</span><span class="s1">&#39;prop_MH&#39;</span><span class="p">])</span>
            <span class="n">new_dataset</span><span class="p">[</span><span class="s1">&#39;radar_out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span>
                <span class="s1">&#39;proportion_IH&#39;</span><span class="p">,</span> <span class="n">fields_dict</span><span class="p">[</span><span class="s1">&#39;prop_IH&#39;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">new_dataset</span><span class="p">,</span> <span class="n">ind_rad</span></div>


<div class="viewcode-block" id="process_melting_layer"><a class="viewcode-back" href="../../../proc.html#pyrad.proc.process_melting_layer">[docs]</a><span class="k">def</span> <span class="nf">process_melting_layer</span><span class="p">(</span><span class="n">procstatus</span><span class="p">,</span> <span class="n">dscfg</span><span class="p">,</span> <span class="n">radar_list</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Detects the melting layer</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    procstatus : int</span>
<span class="sd">        Processing status: 0 initializing, 1 processing volume,</span>
<span class="sd">        2 post-processing</span>
<span class="sd">    dscfg : dictionary of dictionaries</span>
<span class="sd">        data set configuration. Accepted Configuration Keywords::</span>

<span class="sd">        datatype : list of string. Dataset keyword</span>
<span class="sd">            The input data types</span>
<span class="sd">    radar_list : list of Radar objects</span>
<span class="sd">        Optional. list of radar objects</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    new_dataset : dict</span>
<span class="sd">        dictionary containing the output</span>
<span class="sd">    ind_rad : int</span>
<span class="sd">        radar index</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">procstatus</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="s1">&#39;ML_METHOD&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dscfg</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
            <span class="s2">&quot;ERROR: Undefined parameter &#39;ML_METHOD&#39; for dataset &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span>
            <span class="o">%</span> <span class="n">dscfg</span><span class="p">[</span><span class="s1">&#39;dsname&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">dscfg</span><span class="p">[</span><span class="s1">&#39;ML_METHOD&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;GIANGRANDE&#39;</span><span class="p">:</span>

        <span class="n">temp_ref</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">temp_field</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">iso0_field</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">datatypedescr</span> <span class="ow">in</span> <span class="n">dscfg</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]:</span>
            <span class="n">radarnr</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">datatype</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_datatype_fields</span><span class="p">(</span><span class="n">datatypedescr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;dBZ&#39;</span><span class="p">:</span>
                <span class="n">refl_field</span> <span class="o">=</span> <span class="s1">&#39;reflectivity&#39;</span>
            <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;dBZc&#39;</span><span class="p">:</span>
                <span class="n">refl_field</span> <span class="o">=</span> <span class="s1">&#39;corrected_reflectivity&#39;</span>
            <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;ZDR&#39;</span><span class="p">:</span>
                <span class="n">zdr_field</span> <span class="o">=</span> <span class="s1">&#39;differential_reflectivity&#39;</span>
            <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;ZDRc&#39;</span><span class="p">:</span>
                <span class="n">zdr_field</span> <span class="o">=</span> <span class="s1">&#39;corrected_differential_reflectivity&#39;</span>
            <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;RhoHV&#39;</span><span class="p">:</span>
                <span class="n">rhv_field</span> <span class="o">=</span> <span class="s1">&#39;cross_correlation_ratio&#39;</span>
            <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;RhoHVc&#39;</span><span class="p">:</span>
                <span class="n">rhv_field</span> <span class="o">=</span> <span class="s1">&#39;corrected_cross_correlation_ratio&#39;</span>
            <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;TEMP&#39;</span><span class="p">:</span>
                <span class="n">temp_field</span> <span class="o">=</span> <span class="s1">&#39;temperature&#39;</span>
            <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;H_ISO0&#39;</span><span class="p">:</span>
                <span class="n">iso0_field</span> <span class="o">=</span> <span class="s1">&#39;height_over_iso0&#39;</span>

        <span class="n">ind_rad</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">radarnr</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">8</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">radar_list</span><span class="p">[</span><span class="n">ind_rad</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;No valid radar&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="n">radar</span> <span class="o">=</span> <span class="n">radar_list</span><span class="p">[</span><span class="n">ind_rad</span><span class="p">]</span>

        <span class="c1"># Check which should be the reference field for temperature</span>
        <span class="k">if</span> <span class="n">iso0_field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">iso0_field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">radar</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
                <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Unable to detect melting layer. &#39;</span> <span class="o">+</span>
                     <span class="s1">&#39;Missing height over iso0 field&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
            <span class="n">temp_ref</span> <span class="o">=</span> <span class="s1">&#39;height_over_iso0&#39;</span>

        <span class="k">if</span> <span class="n">temp_field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">temp_field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">radar</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
                <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Unable to detect melting layer. &#39;</span> <span class="o">+</span>
                     <span class="s1">&#39;Missing temperature field&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
            <span class="n">temp_ref</span> <span class="o">=</span> <span class="s1">&#39;temperature&#39;</span>
            <span class="n">iso0_field</span> <span class="o">=</span> <span class="s1">&#39;height_over_iso0&#39;</span>

        <span class="k">if</span> <span class="n">temp_ref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">iso0_field</span> <span class="o">=</span> <span class="s1">&#39;height_over_iso0&#39;</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">refl_field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">radar</span><span class="o">.</span><span class="n">fields</span><span class="p">)</span> <span class="ow">or</span>
                <span class="p">(</span><span class="n">zdr_field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">radar</span><span class="o">.</span><span class="n">fields</span><span class="p">)</span> <span class="ow">or</span>
                <span class="p">(</span><span class="n">rhv_field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">radar</span><span class="o">.</span><span class="n">fields</span><span class="p">)):</span>
            <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Unable to detect melting layer. Missing data&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="c1"># User defined variables</span>
        <span class="n">nVol</span> <span class="o">=</span> <span class="n">dscfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nVol&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">maxh</span> <span class="o">=</span> <span class="n">dscfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;maxh&#39;</span><span class="p">,</span> <span class="mf">6000.</span><span class="p">)</span>
        <span class="n">hres</span> <span class="o">=</span> <span class="n">dscfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hres&#39;</span><span class="p">,</span> <span class="mf">50.</span><span class="p">)</span>

        <span class="n">rmin</span> <span class="o">=</span> <span class="n">dscfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rmin&#39;</span><span class="p">,</span> <span class="mf">1000.</span><span class="p">)</span>
        <span class="n">elmin</span> <span class="o">=</span> <span class="n">dscfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;elmin&#39;</span><span class="p">,</span> <span class="mf">4.</span><span class="p">)</span>
        <span class="n">elmax</span> <span class="o">=</span> <span class="n">dscfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;elmax&#39;</span><span class="p">,</span> <span class="mf">10.</span><span class="p">)</span>
        <span class="n">rhomin</span> <span class="o">=</span> <span class="n">dscfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rhomin&#39;</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">)</span>
        <span class="n">rhomax</span> <span class="o">=</span> <span class="n">dscfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rhomax&#39;</span><span class="p">,</span> <span class="mf">0.94</span><span class="p">)</span>
        <span class="n">zhmin</span> <span class="o">=</span> <span class="n">dscfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;zhmin&#39;</span><span class="p">,</span> <span class="mf">20.</span><span class="p">)</span>
        <span class="n">hwindow</span> <span class="o">=</span> <span class="n">dscfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hwindow&#39;</span><span class="p">,</span> <span class="mf">500.</span><span class="p">)</span>
        <span class="n">mlzhmin</span> <span class="o">=</span> <span class="n">dscfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mlzhmin&#39;</span><span class="p">,</span> <span class="mf">30.</span><span class="p">)</span>
        <span class="n">mlzhmax</span> <span class="o">=</span> <span class="n">dscfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mlzhmax&#39;</span><span class="p">,</span> <span class="mf">50.</span><span class="p">)</span>
        <span class="n">mlzdrmin</span> <span class="o">=</span> <span class="n">dscfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mlzdrmin&#39;</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
        <span class="n">mlzdrmax</span> <span class="o">=</span> <span class="n">dscfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mlzdrmax&#39;</span><span class="p">,</span> <span class="mf">5.</span><span class="p">)</span>
        <span class="n">htol</span> <span class="o">=</span> <span class="n">dscfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;htol&#39;</span><span class="p">,</span> <span class="mf">500.</span><span class="p">)</span>
        <span class="n">ml_bottom_diff_max</span> <span class="o">=</span> <span class="n">dscfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ml_bottom_diff_max&#39;</span><span class="p">,</span> <span class="mf">1000.</span><span class="p">)</span>

        <span class="n">time_accu_max</span> <span class="o">=</span> <span class="n">dscfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;time_accu_max&#39;</span><span class="p">,</span> <span class="mf">1800.</span><span class="p">)</span>
        <span class="n">nml_points_min</span> <span class="o">=</span> <span class="n">dscfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nml_points_min&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">wlength</span> <span class="o">=</span> <span class="n">dscfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wlength&#39;</span><span class="p">,</span> <span class="mf">20.</span><span class="p">)</span>
        <span class="n">percentile_bottom</span> <span class="o">=</span> <span class="n">dscfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;percentile_bottom&#39;</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)</span>
        <span class="n">percentile_top</span> <span class="o">=</span> <span class="n">dscfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;percentile_top&#39;</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">)</span>
        <span class="n">interpol</span> <span class="o">=</span> <span class="n">dscfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;interpol&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">time_nodata_allowed</span> <span class="o">=</span> <span class="n">dscfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;time_nodata_allowed&#39;</span><span class="p">,</span> <span class="mf">3600.</span><span class="p">)</span>

        <span class="n">get_iso0</span> <span class="o">=</span> <span class="n">dscfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;get_iso0&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">dscfg</span><span class="p">[</span><span class="s1">&#39;initialized&#39;</span><span class="p">]:</span>
            <span class="c1"># initialize dataset</span>
            <span class="n">ml_obj</span><span class="p">,</span> <span class="n">ml_dict</span><span class="p">,</span> <span class="n">iso0_dict</span><span class="p">,</span> <span class="n">ml_global</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">pyart</span><span class="o">.</span><span class="n">retrieve</span><span class="o">.</span><span class="n">melting_layer_giangrande</span><span class="p">(</span>
                    <span class="n">radar</span><span class="p">,</span> <span class="n">nVol</span><span class="o">=</span><span class="n">nVol</span><span class="p">,</span> <span class="n">maxh</span><span class="o">=</span><span class="n">maxh</span><span class="p">,</span> <span class="n">hres</span><span class="o">=</span><span class="n">hres</span><span class="p">,</span> <span class="n">rmin</span><span class="o">=</span><span class="n">rmin</span><span class="p">,</span>
                    <span class="n">elmin</span><span class="o">=</span><span class="n">elmin</span><span class="p">,</span> <span class="n">elmax</span><span class="o">=</span><span class="n">elmax</span><span class="p">,</span> <span class="n">rhomin</span><span class="o">=</span><span class="n">rhomin</span><span class="p">,</span> <span class="n">rhomax</span><span class="o">=</span><span class="n">rhomax</span><span class="p">,</span>
                    <span class="n">zhmin</span><span class="o">=</span><span class="n">zhmin</span><span class="p">,</span> <span class="n">hwindow</span><span class="o">=</span><span class="n">hwindow</span><span class="p">,</span> <span class="n">mlzhmin</span><span class="o">=</span><span class="n">mlzhmin</span><span class="p">,</span>
                    <span class="n">mlzhmax</span><span class="o">=</span><span class="n">mlzhmax</span><span class="p">,</span> <span class="n">mlzdrmin</span><span class="o">=</span><span class="n">mlzdrmin</span><span class="p">,</span> <span class="n">mlzdrmax</span><span class="o">=</span><span class="n">mlzdrmax</span><span class="p">,</span>
                    <span class="n">htol</span><span class="o">=</span><span class="n">htol</span><span class="p">,</span> <span class="n">ml_bottom_diff_max</span><span class="o">=</span><span class="n">ml_bottom_diff_max</span><span class="p">,</span>
                    <span class="n">time_accu_max</span><span class="o">=</span><span class="n">time_accu_max</span><span class="p">,</span> <span class="n">nml_points_min</span><span class="o">=</span><span class="n">nml_points_min</span><span class="p">,</span>
                    <span class="n">wlength</span><span class="o">=</span><span class="n">wlength</span><span class="p">,</span> <span class="n">percentile_bottom</span><span class="o">=</span><span class="n">percentile_bottom</span><span class="p">,</span>
                    <span class="n">percentile_top</span><span class="o">=</span><span class="n">percentile_top</span><span class="p">,</span> <span class="n">interpol</span><span class="o">=</span><span class="n">interpol</span><span class="p">,</span>
                    <span class="n">time_nodata_allowed</span><span class="o">=</span><span class="n">time_nodata_allowed</span><span class="p">,</span>
                    <span class="n">refl_field</span><span class="o">=</span><span class="n">refl_field</span><span class="p">,</span> <span class="n">zdr_field</span><span class="o">=</span><span class="n">zdr_field</span><span class="p">,</span>
                    <span class="n">rhv_field</span><span class="o">=</span><span class="n">rhv_field</span><span class="p">,</span> <span class="n">temp_field</span><span class="o">=</span><span class="n">temp_field</span><span class="p">,</span>
                    <span class="n">iso0_field</span><span class="o">=</span><span class="n">iso0_field</span><span class="p">,</span> <span class="n">ml_field</span><span class="o">=</span><span class="s1">&#39;melting_layer&#39;</span><span class="p">,</span>
                    <span class="n">ml_pos_field</span><span class="o">=</span><span class="s1">&#39;melting_layer_height&#39;</span><span class="p">,</span>
                    <span class="n">temp_ref</span><span class="o">=</span><span class="n">temp_ref</span><span class="p">,</span> <span class="n">get_iso0</span><span class="o">=</span><span class="n">get_iso0</span><span class="p">,</span> <span class="n">ml_global</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>
            <span class="n">dscfg</span><span class="p">[</span><span class="s1">&#39;initialized&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># use previous detection</span>
            <span class="n">ml_obj</span><span class="p">,</span> <span class="n">ml_dict</span><span class="p">,</span> <span class="n">iso0_dict</span><span class="p">,</span> <span class="n">ml_global</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">pyart</span><span class="o">.</span><span class="n">retrieve</span><span class="o">.</span><span class="n">melting_layer_giangrande</span><span class="p">(</span>
                    <span class="n">radar</span><span class="p">,</span> <span class="n">nVol</span><span class="o">=</span><span class="n">nVol</span><span class="p">,</span> <span class="n">maxh</span><span class="o">=</span><span class="n">maxh</span><span class="p">,</span> <span class="n">hres</span><span class="o">=</span><span class="n">hres</span><span class="p">,</span> <span class="n">rmin</span><span class="o">=</span><span class="n">rmin</span><span class="p">,</span>
                    <span class="n">elmin</span><span class="o">=</span><span class="n">elmin</span><span class="p">,</span> <span class="n">elmax</span><span class="o">=</span><span class="n">elmax</span><span class="p">,</span> <span class="n">rhomin</span><span class="o">=</span><span class="n">rhomin</span><span class="p">,</span> <span class="n">rhomax</span><span class="o">=</span><span class="n">rhomax</span><span class="p">,</span>
                    <span class="n">zhmin</span><span class="o">=</span><span class="n">zhmin</span><span class="p">,</span> <span class="n">hwindow</span><span class="o">=</span><span class="n">hwindow</span><span class="p">,</span> <span class="n">mlzhmin</span><span class="o">=</span><span class="n">mlzhmin</span><span class="p">,</span>
                    <span class="n">mlzhmax</span><span class="o">=</span><span class="n">mlzhmax</span><span class="p">,</span> <span class="n">mlzdrmin</span><span class="o">=</span><span class="n">mlzdrmin</span><span class="p">,</span> <span class="n">mlzdrmax</span><span class="o">=</span><span class="n">mlzdrmax</span><span class="p">,</span>
                    <span class="n">htol</span><span class="o">=</span><span class="n">htol</span><span class="p">,</span> <span class="n">ml_bottom_diff_max</span><span class="o">=</span><span class="n">ml_bottom_diff_max</span><span class="p">,</span>
                    <span class="n">time_accu_max</span><span class="o">=</span><span class="n">time_accu_max</span><span class="p">,</span> <span class="n">nml_points_min</span><span class="o">=</span><span class="n">nml_points_min</span><span class="p">,</span>
                    <span class="n">wlength</span><span class="o">=</span><span class="n">wlength</span><span class="p">,</span> <span class="n">percentile_bottom</span><span class="o">=</span><span class="n">percentile_bottom</span><span class="p">,</span>
                    <span class="n">percentile_top</span><span class="o">=</span><span class="n">percentile_top</span><span class="p">,</span> <span class="n">interpol</span><span class="o">=</span><span class="n">interpol</span><span class="p">,</span>
                    <span class="n">time_nodata_allowed</span><span class="o">=</span><span class="n">time_nodata_allowed</span><span class="p">,</span>
                    <span class="n">refl_field</span><span class="o">=</span><span class="n">refl_field</span><span class="p">,</span> <span class="n">zdr_field</span><span class="o">=</span><span class="n">zdr_field</span><span class="p">,</span>
                    <span class="n">rhv_field</span><span class="o">=</span><span class="n">rhv_field</span><span class="p">,</span> <span class="n">temp_field</span><span class="o">=</span><span class="n">temp_field</span><span class="p">,</span>
                    <span class="n">iso0_field</span><span class="o">=</span><span class="n">iso0_field</span><span class="p">,</span> <span class="n">ml_field</span><span class="o">=</span><span class="s1">&#39;melting_layer&#39;</span><span class="p">,</span>
                    <span class="n">ml_pos_field</span><span class="o">=</span><span class="s1">&#39;melting_layer_height&#39;</span><span class="p">,</span>
                    <span class="n">temp_ref</span><span class="o">=</span><span class="n">temp_ref</span><span class="p">,</span> <span class="n">get_iso0</span><span class="o">=</span><span class="n">get_iso0</span><span class="p">,</span>
                    <span class="n">ml_global</span><span class="o">=</span><span class="n">dscfg</span><span class="p">[</span><span class="s1">&#39;global_data&#39;</span><span class="p">]))</span>

        <span class="c1"># update global stack</span>
        <span class="n">dscfg</span><span class="p">[</span><span class="s1">&#39;global_data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ml_global</span>

    <span class="k">elif</span> <span class="n">dscfg</span><span class="p">[</span><span class="s1">&#39;ML_METHOD&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;WOLFENSBERGER&#39;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">datatypedescr</span> <span class="ow">in</span> <span class="n">dscfg</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]:</span>
            <span class="n">radarnr</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">datatype</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_datatype_fields</span><span class="p">(</span><span class="n">datatypedescr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;dBZ&#39;</span><span class="p">:</span>
                <span class="n">refl_field</span> <span class="o">=</span> <span class="s1">&#39;reflectivity&#39;</span>
            <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;dBZc&#39;</span><span class="p">:</span>
                <span class="n">refl_field</span> <span class="o">=</span> <span class="s1">&#39;corrected_reflectivity&#39;</span>
            <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;RhoHV&#39;</span><span class="p">:</span>
                <span class="n">rhohv_field</span> <span class="o">=</span> <span class="s1">&#39;cross_correlation_ratio&#39;</span>
            <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;RhoHVc&#39;</span><span class="p">:</span>
                <span class="n">rhohv_field</span> <span class="o">=</span> <span class="s1">&#39;corrected_cross_correlation_ratio&#39;</span>

        <span class="n">ind_rad</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">radarnr</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">8</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">radar_list</span><span class="p">[</span><span class="n">ind_rad</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;No valid radar&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="n">radar</span> <span class="o">=</span> <span class="n">radar_list</span><span class="p">[</span><span class="n">ind_rad</span><span class="p">]</span>

        <span class="k">if</span> <span class="p">((</span><span class="n">refl_field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">radar</span><span class="o">.</span><span class="n">fields</span><span class="p">)</span> <span class="ow">or</span>
                <span class="p">(</span><span class="n">rhohv_field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">radar</span><span class="o">.</span><span class="n">fields</span><span class="p">)):</span>
            <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Unable to detect melting layer. Missing data&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="c1"># User defined parameters</span>
        <span class="n">max_range</span> <span class="o">=</span> <span class="n">dscfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_range&#39;</span><span class="p">,</span> <span class="mf">20000.</span><span class="p">)</span>
        <span class="n">detect_threshold</span> <span class="o">=</span> <span class="n">dscfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;detect_threshold&#39;</span><span class="p">,</span> <span class="mf">0.02</span><span class="p">)</span>
        <span class="n">interp_holes</span> <span class="o">=</span> <span class="n">dscfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;interp_holes&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">max_length_holes</span> <span class="o">=</span> <span class="n">dscfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_length_holes&#39;</span><span class="p">,</span> <span class="mi">250</span><span class="p">)</span>
        <span class="n">check_min_length</span> <span class="o">=</span> <span class="n">dscfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;check_min_length&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">get_iso0</span> <span class="o">=</span> <span class="n">dscfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;get_iso0&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="n">ml_obj</span><span class="p">,</span> <span class="n">ml_dict</span><span class="p">,</span> <span class="n">iso0_dict</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">pyart</span><span class="o">.</span><span class="n">retrieve</span><span class="o">.</span><span class="n">detect_ml</span><span class="p">(</span>
            <span class="n">radar</span><span class="p">,</span> <span class="n">refl_field</span><span class="o">=</span><span class="n">refl_field</span><span class="p">,</span> <span class="n">rhohv_field</span><span class="o">=</span><span class="n">rhohv_field</span><span class="p">,</span>
            <span class="n">ml_field</span><span class="o">=</span><span class="s1">&#39;melting_layer&#39;</span><span class="p">,</span> <span class="n">ml_pos_field</span><span class="o">=</span><span class="s1">&#39;melting_layer_height&#39;</span><span class="p">,</span>
            <span class="n">iso0_field</span><span class="o">=</span><span class="s1">&#39;height_over_iso0&#39;</span><span class="p">,</span> <span class="n">max_range</span><span class="o">=</span><span class="n">max_range</span><span class="p">,</span>
            <span class="n">detect_threshold</span><span class="o">=</span><span class="n">detect_threshold</span><span class="p">,</span> <span class="n">interp_holes</span><span class="o">=</span><span class="n">interp_holes</span><span class="p">,</span>
            <span class="n">max_length_holes</span><span class="o">=</span><span class="n">max_length_holes</span><span class="p">,</span>
            <span class="n">check_min_length</span><span class="o">=</span><span class="n">check_min_length</span><span class="p">,</span> <span class="n">get_iso0</span><span class="o">=</span><span class="n">get_iso0</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">dscfg</span><span class="p">[</span><span class="s1">&#39;ML_METHOD&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;FROM_HYDROCLASS&#39;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">datatypedescr</span> <span class="ow">in</span> <span class="n">dscfg</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]:</span>
            <span class="n">radarnr</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">datatype</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_datatype_fields</span><span class="p">(</span><span class="n">datatypedescr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;hydro&#39;</span><span class="p">:</span>
                <span class="n">hydro_field</span> <span class="o">=</span> <span class="n">get_fieldname_pyart</span><span class="p">(</span><span class="n">datatype</span><span class="p">)</span>

        <span class="n">ind_rad</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">radarnr</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">8</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">radar_list</span><span class="p">[</span><span class="n">ind_rad</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;No valid radar&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="n">radar</span> <span class="o">=</span> <span class="n">radar_list</span><span class="p">[</span><span class="n">ind_rad</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">hydro_field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">radar</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Unable to detect melting layer. Missing data&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="c1"># User defined parameters</span>
        <span class="n">force_continuity</span> <span class="o">=</span> <span class="n">dscfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;force_continuity&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">dist_max</span> <span class="o">=</span> <span class="n">dscfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dist_max&#39;</span><span class="p">,</span> <span class="mf">350.</span><span class="p">)</span>
        <span class="n">get_iso0</span> <span class="o">=</span> <span class="n">dscfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;get_iso0&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="n">ml_obj</span><span class="p">,</span> <span class="n">ml_dict</span><span class="p">,</span> <span class="n">iso0_dict</span> <span class="o">=</span> <span class="n">pyart</span><span class="o">.</span><span class="n">retrieve</span><span class="o">.</span><span class="n">melting_layer_hydroclass</span><span class="p">(</span>
            <span class="n">radar</span><span class="p">,</span> <span class="n">hydro_field</span><span class="o">=</span><span class="n">hydro_field</span><span class="p">,</span> <span class="n">ml_field</span><span class="o">=</span><span class="s1">&#39;melting_layer&#39;</span><span class="p">,</span>
            <span class="n">ml_pos_field</span><span class="o">=</span><span class="s1">&#39;melting_layer_height&#39;</span><span class="p">,</span>
            <span class="n">iso0_field</span><span class="o">=</span><span class="s1">&#39;height_over_iso0&#39;</span><span class="p">,</span> <span class="n">force_continuity</span><span class="o">=</span><span class="n">force_continuity</span><span class="p">,</span>
            <span class="n">dist_max</span><span class="o">=</span><span class="n">dist_max</span><span class="p">,</span> <span class="n">get_iso0</span><span class="o">=</span><span class="n">get_iso0</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
            <span class="s2">&quot;ERROR: Unknown melting layer retrieval method &quot;</span> <span class="o">+</span>
            <span class="n">dscfg</span><span class="p">[</span><span class="s1">&#39;ML_METHOD&#39;</span><span class="p">])</span>

    <span class="c1"># prepare for exit</span>
    <span class="k">if</span> <span class="n">ml_dict</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="n">new_dataset</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;radar_out&#39;</span><span class="p">:</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">radar</span><span class="p">)}</span>
    <span class="n">new_dataset</span><span class="p">[</span><span class="s1">&#39;radar_out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">new_dataset</span><span class="p">[</span><span class="s1">&#39;radar_out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="s1">&#39;melting_layer&#39;</span><span class="p">,</span> <span class="n">ml_dict</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">iso0_dict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">new_dataset</span><span class="p">[</span><span class="s1">&#39;radar_out&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="s1">&#39;height_over_iso0&#39;</span><span class="p">,</span> <span class="n">iso0_dict</span><span class="p">)</span>
    <span class="n">new_dataset</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;ml_obj&#39;</span><span class="p">:</span> <span class="n">ml_obj</span><span class="p">})</span>

    <span class="k">return</span> <span class="n">new_dataset</span><span class="p">,</span> <span class="n">ind_rad</span></div>


<div class="viewcode-block" id="process_zdr_column"><a class="viewcode-back" href="../../../proc.html#pyrad.proc.process_zdr_column">[docs]</a><span class="k">def</span> <span class="nf">process_zdr_column</span><span class="p">(</span><span class="n">procstatus</span><span class="p">,</span> <span class="n">dscfg</span><span class="p">,</span> <span class="n">radar_list</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Detects ZDR columns</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    procstatus : int</span>
<span class="sd">        Processing status: 0 initializing, 1 processing volume,</span>
<span class="sd">        2 post-processing</span>
<span class="sd">    dscfg : dictionary of dictionaries</span>
<span class="sd">        data set configuration. Accepted Configuration Keywords::</span>

<span class="sd">        datatype : list of string. Dataset keyword</span>
<span class="sd">            The input data types</span>
<span class="sd">    radar_list : list of Radar objects</span>
<span class="sd">        Optional. list of radar objects</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    new_dataset : dict</span>
<span class="sd">        dictionary containing the output</span>
<span class="sd">    ind_rad : int</span>
<span class="sd">        radar index</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">procstatus</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="n">temp_field</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">iso0_field</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">datatypedescr</span> <span class="ow">in</span> <span class="n">dscfg</span><span class="p">[</span><span class="s1">&#39;datatype&#39;</span><span class="p">]:</span>
        <span class="n">radarnr</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">datatype</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_datatype_fields</span><span class="p">(</span><span class="n">datatypedescr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;ZDR&#39;</span><span class="p">:</span>
            <span class="n">zdr_field</span> <span class="o">=</span> <span class="s1">&#39;differential_reflectivity&#39;</span>
        <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;ZDRc&#39;</span><span class="p">:</span>
            <span class="n">zdr_field</span> <span class="o">=</span> <span class="s1">&#39;corrected_differential_reflectivity&#39;</span>
        <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;RhoHV&#39;</span><span class="p">:</span>
            <span class="n">rhv_field</span> <span class="o">=</span> <span class="s1">&#39;cross_correlation_ratio&#39;</span>
        <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;RhoHVc&#39;</span><span class="p">:</span>
            <span class="n">rhv_field</span> <span class="o">=</span> <span class="s1">&#39;corrected_cross_correlation_ratio&#39;</span>
        <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;TEMP&#39;</span><span class="p">:</span>
            <span class="n">temp_field</span> <span class="o">=</span> <span class="s1">&#39;temperature&#39;</span>
        <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="s1">&#39;H_ISO0&#39;</span><span class="p">:</span>
            <span class="n">iso0_field</span> <span class="o">=</span> <span class="s1">&#39;height_over_iso0&#39;</span>

    <span class="n">ind_rad</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">radarnr</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">8</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span>
    <span class="k">if</span> <span class="n">radar_list</span><span class="p">[</span><span class="n">ind_rad</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;No valid radar&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">radar</span> <span class="o">=</span> <span class="n">radar_list</span><span class="p">[</span><span class="n">ind_rad</span><span class="p">]</span>

    <span class="c1"># Check which should be the reference field for temperature</span>
    <span class="k">if</span> <span class="n">iso0_field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">iso0_field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">radar</span><span class="o">.</span><span class="n">fields</span><span class="p">):</span>
        <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Unable to detect melting layer. &#39;</span> <span class="o">+</span>
             <span class="s1">&#39;Missing height over iso0 field&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">temp_ref</span> <span class="o">=</span> <span class="s1">&#39;height_over_iso0&#39;</span>

    <span class="k">if</span> <span class="n">temp_field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">temp_field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">radar</span><span class="o">.</span><span class="n">fields</span><span class="p">):</span>
        <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Unable to detect melting layer. Missing temperature field&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">temp_ref</span> <span class="o">=</span> <span class="s1">&#39;temperature&#39;</span>
    <span class="n">iso0_field</span> <span class="o">=</span> <span class="s1">&#39;height_over_iso0&#39;</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">zdr_field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">radar</span><span class="o">.</span><span class="n">fields</span><span class="p">)</span> <span class="ow">or</span>
            <span class="p">(</span><span class="n">rhv_field</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">radar</span><span class="o">.</span><span class="n">fields</span><span class="p">)):</span>
        <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Unable to detect melting layer. Missing data&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="n">rhohv_min</span> <span class="o">=</span> <span class="n">dscfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rhohv_min&#39;</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">)</span>
    <span class="n">zdr_min</span> <span class="o">=</span> <span class="n">dscfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;zdr_min&#39;</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
    <span class="n">smooth_window</span> <span class="o">=</span> <span class="n">dscfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;smooth_window&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
    <span class="n">latlon_tol</span> <span class="o">=</span> <span class="n">dscfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;latlon_tol&#39;</span><span class="p">,</span> <span class="mf">0.025</span><span class="p">)</span>  <span class="c1"># approx 3x2 km</span>
    <span class="k">if</span> <span class="n">smooth_window</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">smooth_window_len</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">smooth_window_len</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
            <span class="n">smooth_window</span><span class="o">/</span><span class="p">(</span><span class="n">radar</span><span class="o">.</span><span class="n">range</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">radar</span><span class="o">.</span><span class="n">range</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>

    <span class="n">zdr_dict</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">radar</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">zdr_field</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">smooth_window_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">zdr_dict</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pyart</span><span class="o">.</span><span class="n">correct</span><span class="o">.</span><span class="n">smooth_masked</span><span class="p">(</span>
            <span class="n">zdr_dict</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">],</span> <span class="n">wind_len</span><span class="o">=</span><span class="n">smooth_window_len</span><span class="p">,</span> <span class="n">min_valid</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">wind_type</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span>

    <span class="n">zdr_dict</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">radar</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">rhv_field</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">rhohv_min</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
    <span class="n">zdr_dict</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">zdr_dict</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">zdr_min</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
    <span class="n">zdr_dict</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">radar</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">temp_field</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked</span>
    <span class="n">zdr_valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">getmaskarray</span><span class="p">(</span><span class="n">zdr_dict</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]))</span>

    <span class="n">hlowerleft</span><span class="p">,</span> <span class="n">hupperright</span> <span class="o">=</span> <span class="n">pyart</span><span class="o">.</span><span class="n">retrieve</span><span class="o">.</span><span class="n">_get_res_vol_sides</span><span class="p">(</span><span class="n">radar</span><span class="p">)</span>
    <span class="n">ind_ang_sorted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">radar</span><span class="o">.</span><span class="n">fixed_angle</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">])</span>

    <span class="c1"># get number of suspected ZDR columns</span>
    <span class="n">lat_cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">lon_cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">zdr_cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

    <span class="n">g_lat</span> <span class="o">=</span> <span class="n">radar</span><span class="o">.</span><span class="n">gate_latitude</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
    <span class="n">g_lon</span> <span class="o">=</span> <span class="n">radar</span><span class="o">.</span><span class="n">gate_longitude</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">ind_ray</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">radar</span><span class="o">.</span><span class="n">nrays</span><span class="p">):</span>
        <span class="c1"># Get bins with negative temperatures</span>
        <span class="n">ind_rngs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">radar</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">temp_field</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">ind_ray</span><span class="p">,</span> <span class="p">:]</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">ind_rngs</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># Segment negative temperatures and get start of each segment</span>
        <span class="n">cons_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">ind_rngs</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">ind_rngs</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ind_rngs_cell</span> <span class="ow">in</span> <span class="n">cons_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">zdr_valid</span><span class="p">[</span><span class="n">ind_ray</span><span class="p">,</span> <span class="n">ind_rngs_cell</span><span class="p">[</span><span class="mi">0</span><span class="p">]]:</span>
                <span class="k">continue</span>

            <span class="n">ind_ray_col</span> <span class="o">=</span> <span class="n">ind_ray</span>
            <span class="n">ind_rng_col</span> <span class="o">=</span> <span class="n">ind_rngs_cell</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># extract data around point:</span>
            <span class="n">ind_rays</span><span class="p">,</span> <span class="n">ind_rngs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="o">.</span><span class="n">reduce</span><span class="p">((</span>
                <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                    <span class="n">g_lat</span> <span class="o">&gt;=</span> <span class="n">g_lat</span><span class="p">[</span><span class="n">ind_ray_col</span><span class="p">,</span> <span class="n">ind_rng_col</span><span class="p">]</span><span class="o">-</span><span class="n">latlon_tol</span><span class="p">,</span>
                    <span class="n">g_lat</span> <span class="o">&lt;=</span> <span class="n">g_lat</span><span class="p">[</span><span class="n">ind_ray_col</span><span class="p">,</span> <span class="n">ind_rng_col</span><span class="p">]</span><span class="o">+</span><span class="n">latlon_tol</span><span class="p">),</span>
                <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                    <span class="n">g_lon</span> <span class="o">&gt;=</span> <span class="n">g_lon</span><span class="p">[</span><span class="n">ind_ray_col</span><span class="p">,</span> <span class="n">ind_rng_col</span><span class="p">]</span><span class="o">-</span><span class="n">latlon_tol</span><span class="p">,</span>
                    <span class="n">g_lon</span> <span class="o">&lt;=</span> <span class="n">g_lon</span><span class="p">[</span><span class="n">ind_ray_col</span><span class="p">,</span> <span class="n">ind_rng_col</span><span class="p">]</span><span class="o">+</span><span class="n">latlon_tol</span><span class="p">),</span>
                <span class="n">zdr_valid</span><span class="p">)))</span>

            <span class="c1"># get ZDR column height for each radar sweep</span>
            <span class="n">h_low</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_all</span><span class="p">(</span><span class="n">radar</span><span class="o">.</span><span class="n">nsweeps</span><span class="p">)</span>
            <span class="n">h_high</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_all</span><span class="p">(</span><span class="n">radar</span><span class="o">.</span><span class="n">nsweeps</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">sweep</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">radar</span><span class="o">.</span><span class="n">nsweeps</span><span class="p">):</span>
                <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                    <span class="n">ind_rays</span> <span class="o">&gt;=</span> <span class="n">radar</span><span class="o">.</span><span class="n">sweep_start_ray_index</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">sweep</span><span class="p">],</span>
                    <span class="n">ind_rays</span> <span class="o">&lt;=</span> <span class="n">radar</span><span class="o">.</span><span class="n">sweep_end_ray_index</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">sweep</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">ind</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">h_low</span><span class="p">[</span><span class="n">sweep</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span>
                    <span class="n">hlowerleft</span><span class="p">[</span><span class="n">ind_rays</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span> <span class="n">ind_rngs</span><span class="p">[</span><span class="n">ind</span><span class="p">]])</span>
                <span class="n">h_high</span><span class="p">[</span><span class="n">sweep</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span>
                    <span class="n">hupperright</span><span class="p">[</span><span class="n">ind_rays</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span> <span class="n">ind_rngs</span><span class="p">[</span><span class="n">ind</span><span class="p">]])</span>

            <span class="c1"># order data by elevation angle</span>
            <span class="n">h_low</span> <span class="o">=</span> <span class="n">h_low</span><span class="p">[</span><span class="n">ind_ang_sorted</span><span class="p">]</span>
            <span class="n">h_high</span> <span class="o">=</span> <span class="n">h_high</span><span class="p">[</span><span class="n">ind_ang_sorted</span><span class="p">]</span>

            <span class="c1"># get the first segment of continuous ZDR valid values</span>
            <span class="n">ind_valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">getmaskarray</span><span class="p">(</span><span class="n">h_low</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">ind_valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
                <span class="n">ind_valid</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">ind_valid</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># compute ZDR column</span>
            <span class="n">zdr_col</span> <span class="o">=</span> <span class="n">h_high</span><span class="p">[</span><span class="n">ind_valid</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span><span class="o">-</span><span class="n">h_low</span><span class="p">[</span><span class="n">ind_valid</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

            <span class="c1"># put data in output array</span>
            <span class="n">lat_cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">lat_cols</span><span class="p">,</span> <span class="n">radar</span><span class="o">.</span><span class="n">gate_latitude</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">ind_ray_col</span><span class="p">,</span> <span class="n">ind_rng_col</span><span class="p">])</span>
            <span class="n">lon_cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">lon_cols</span><span class="p">,</span> <span class="n">radar</span><span class="o">.</span><span class="n">gate_longitude</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">ind_ray_col</span><span class="p">,</span> <span class="n">ind_rng_col</span><span class="p">])</span>
            <span class="n">zdr_cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">zdr_cols</span><span class="p">,</span> <span class="n">zdr_col</span><span class="p">)</span>


    <span class="n">zdr_col_dict</span> <span class="o">=</span> <span class="n">pyart</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_metadata</span><span class="p">(</span>
        <span class="s1">&#39;differential_reflectivity_column_height&#39;</span><span class="p">)</span>
    <span class="n">zdr_col_dict</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">zdr_cols</span><span class="o">/</span><span class="mf">1000.</span>
    <span class="n">new_dataset</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;field_limits&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">radar</span><span class="o">.</span><span class="n">gate_longitude</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">radar</span><span class="o">.</span><span class="n">gate_longitude</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">radar</span><span class="o">.</span><span class="n">gate_latitude</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">radar</span><span class="o">.</span><span class="n">gate_latitude</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">])],</span>
        <span class="s1">&#39;lat&#39;</span><span class="p">:</span> <span class="n">lat_cols</span><span class="p">,</span>
        <span class="s1">&#39;lon&#39;</span><span class="p">:</span> <span class="n">lon_cols</span><span class="p">,</span>
        <span class="s1">&#39;fields&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;differential_reflectivity_column_height&#39;</span><span class="p">:</span> <span class="n">zdr_col_dict</span><span class="p">}}</span>

    <span class="k">return</span> <span class="n">new_dataset</span><span class="p">,</span> <span class="n">ind_rad</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">pyrad</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../flow.html">processing flow control (<code class="docutils literal notranslate"><span class="pre">pyrad.flow</span></code>)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../proc.html">Dataset processing (<code class="docutils literal notranslate"><span class="pre">pyrad.proc</span></code>)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../prod.html">Products generation (<code class="docutils literal notranslate"><span class="pre">pyrad.prod</span></code>)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../io.html">Input and output (<code class="docutils literal notranslate"><span class="pre">pyrad.io</span></code>)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../graph.html">Plotting (<code class="docutils literal notranslate"><span class="pre">pyrad.graph</span></code>)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../util.html">Utilities (<code class="docutils literal notranslate"><span class="pre">pyrad.util</span></code>)</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, meteoswiss-mdr.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>